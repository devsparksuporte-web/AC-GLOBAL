import{c as e,o as t,r as n,t as r}from"./index-C9yBzEdM.js";import{t as i}from"./adminService-DRZDLqYL.js";import{a,i as o,n as s,o as c,s as l,t as u}from"./validators-CnV3xIXR.js";/* empty css                 */var d=e(t(),1),f=n(),p=()=>(0,f.jsxs)(`svg`,{width:`20`,height:`20`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,f.jsx)(`line`,{x1:`12`,y1:`5`,x2:`12`,y2:`19`}),(0,f.jsx)(`line`,{x1:`5`,y1:`12`,x2:`19`,y2:`12`})]}),m=()=>(0,f.jsxs)(`svg`,{width:`16`,height:`16`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,f.jsx)(`path`,{d:`M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7`}),(0,f.jsx)(`path`,{d:`M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z`})]}),h=()=>(0,f.jsxs)(`svg`,{width:`20`,height:`20`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,f.jsx)(`line`,{x1:`18`,y1:`6`,x2:`6`,y2:`18`}),(0,f.jsx)(`line`,{x1:`6`,y1:`6`,x2:`18`,y2:`18`})]}),g=()=>(0,f.jsxs)(`svg`,{width:`16`,height:`16`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,f.jsx)(`polyline`,{points:`3 6 5 6 21 6`}),(0,f.jsx)(`path`,{d:`M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2`}),(0,f.jsx)(`line`,{x1:`10`,y1:`11`,x2:`10`,y2:`17`}),(0,f.jsx)(`line`,{x1:`14`,y1:`11`,x2:`14`,y2:`17`})]});function _({empresa:e,onClose:t,onSave:n}){let[r,a]=(0,d.useState)({nome:e?.nome||``,cnpj:e?.cnpj||``,email:e?.email||``,telefone:e?.telefone||``,ativo:e?e.ativo:!0}),[s,p]=(0,d.useState)(!1);return(0,f.jsx)(`div`,{className:`modal-overlay`,onClick:t,children:(0,f.jsxs)(`div`,{className:`modal-content`,onClick:e=>e.stopPropagation(),children:[(0,f.jsxs)(`div`,{className:`modal-header`,children:[(0,f.jsx)(`h2`,{className:`modal-title`,children:e?`Editar Empresa`:`Nova Empresa`}),(0,f.jsx)(`button`,{className:`modal-close`,onClick:t,children:(0,f.jsx)(h,{})})]}),(0,f.jsxs)(`form`,{onSubmit:async t=>{t.preventDefault();let a=l(r.cnpj);if(a&&!u(r.cnpj)){alert(`CNPJ inválido. Por favor, verifique os dígitos.`);return}p(!0);try{let t={...r,cnpj:a,telefone:l(r.telefone)};e?await i.atualizarEmpresa(e.id,t):await i.criarEmpresa(t),n()}catch(e){console.error(e),alert(`Erro ao salvar empresa`)}finally{p(!1)}},children:[(0,f.jsxs)(`div`,{className:`modal-body`,children:[(0,f.jsxs)(`div`,{className:`form-group`,children:[(0,f.jsx)(`label`,{className:`form-label`,children:`Nome`}),(0,f.jsx)(`input`,{className:`form-input`,value:r.nome,onChange:e=>a({...r,nome:e.target.value}),required:!0})]}),(0,f.jsxs)(`div`,{className:`form-group`,children:[(0,f.jsx)(`label`,{className:`form-label`,children:`CNPJ`}),(0,f.jsx)(`input`,{className:`form-input`,value:r.cnpj,onChange:e=>a({...r,cnpj:o(e.target.value)}),placeholder:`00.000.000/0000-00`})]}),(0,f.jsxs)(`div`,{className:`form-group`,children:[(0,f.jsx)(`label`,{className:`form-label`,children:`Email`}),(0,f.jsx)(`input`,{className:`form-input`,type:`email`,value:r.email,onChange:e=>a({...r,email:e.target.value}),placeholder:`email@empresa.com`})]}),(0,f.jsxs)(`div`,{className:`form-group`,children:[(0,f.jsx)(`label`,{className:`form-label`,children:`Telefone`}),(0,f.jsx)(`input`,{className:`form-input`,value:r.telefone,onChange:e=>a({...r,telefone:c(e.target.value)}),placeholder:`(00) 0000-0000`})]}),(0,f.jsx)(`div`,{className:`form-group`,children:(0,f.jsxs)(`label`,{className:`form-label`,style:{display:`flex`,alignItems:`center`,gap:`0.5rem`,cursor:`pointer`},children:[(0,f.jsx)(`input`,{type:`checkbox`,checked:r.ativo,onChange:e=>a({...r,ativo:e.target.checked})}),`Empresa Ativa`]})})]}),(0,f.jsxs)(`div`,{className:`modal-footer`,children:[(0,f.jsx)(`button`,{type:`button`,className:`btn-secondary`,onClick:t,children:`Cancelar`}),(0,f.jsx)(`button`,{type:`submit`,className:`btn-primary`,disabled:s,children:s?`Salvando...`:`Salvar`})]})]})]})})}function v({usuario:e,empresas:t,onClose:n,onSave:o,fixedRole:u}){let{userProfile:p}=r(),m=p?.role===`super_admin`,[g,_]=(0,d.useState)({nome:e.nome||``,role:u||e.role||`tecnico`,empresa_id:e.empresa_id||(m?``:p?.empresa_id||``),email:e.email||``,telefone:e.telefone||``,cpf:e.cpf||``,password:``}),[v,y]=(0,d.useState)(!1);return(0,f.jsx)(`div`,{className:`modal-overlay`,onClick:n,children:(0,f.jsxs)(`div`,{className:`modal-content`,onClick:e=>e.stopPropagation(),children:[(0,f.jsxs)(`div`,{className:`modal-header`,children:[(0,f.jsx)(`h2`,{className:`modal-title`,children:e.id?`Editar Usuário: ${e.nome}`:u===`tecnico`?`Novo Técnico`:`Novo Usuário (Acesso + Perfil)`}),(0,f.jsx)(`button`,{className:`modal-close`,onClick:n,children:(0,f.jsx)(h,{})})]}),(0,f.jsxs)(`form`,{onSubmit:async t=>{t.preventDefault();let n=l(g.cpf||``);if(n&&!s(g.cpf||``)){alert(`CPF inválido. Por favor, verifique os dígitos.`);return}y(!0);try{let t={role:g.role,empresa_id:g.empresa_id,nome:g.nome,telefone:l(g.telefone||``),cpf:n,password:g.password};if(e.id)await i.atualizarPerfilUsuario(e.id,t);else{if(!g.email){alert(`E-mail é obrigatório para novos usuários`);return}await i.criarUsuarioComAcesso({...t,email:g.email,password:g.password})}o()}catch(e){console.error(e),alert(e.message||`Erro ao processar usuário`)}finally{y(!1)}},children:[(0,f.jsxs)(`div`,{className:`modal-body`,children:[(0,f.jsxs)(`div`,{className:`form-group`,children:[(0,f.jsx)(`label`,{className:`form-label`,children:`Nome Completo`}),(0,f.jsx)(`input`,{className:`form-input`,value:g.nome,onChange:e=>_({...g,nome:e.target.value}),required:!0})]}),(0,f.jsxs)(`div`,{className:`form-group`,children:[(0,f.jsx)(`label`,{className:`form-label`,children:`E-mail (Login)`}),(0,f.jsx)(`input`,{className:`form-input`,type:`email`,value:g.email,onChange:e=>_({...g,email:e.target.value}),required:!0,disabled:!!e.id,style:e.id?{backgroundColor:`#f1f5f9`,cursor:`not-allowed`}:{}}),e.id&&(0,f.jsx)(`p`,{style:{fontSize:`0.75rem`,color:`#64748b`,marginTop:`0.25rem`},children:`O e-mail não pode ser alterado após a criação.`})]}),(0,f.jsxs)(`div`,{className:`form-group`,children:[(0,f.jsx)(`label`,{className:`form-label`,children:`WhatsApp (Telefone)`}),(0,f.jsx)(`input`,{className:`form-input`,type:`tel`,value:g.telefone,onChange:e=>_({...g,telefone:c(e.target.value)}),placeholder:`(00) 00000-0000`})]}),(0,f.jsxs)(`div`,{className:`form-group`,children:[(0,f.jsx)(`label`,{className:`form-label`,children:`CPF (Opcional)`}),(0,f.jsx)(`input`,{className:`form-input`,value:g.cpf,onChange:e=>_({...g,cpf:a(e.target.value)}),placeholder:`000.000.000-00`})]}),(0,f.jsxs)(`div`,{className:`form-group`,children:[(0,f.jsx)(`label`,{className:`form-label`,children:e.id?`Nova Senha (Opcional)`:`Senha de Acesso`}),(0,f.jsx)(`input`,{className:`form-input`,type:`password`,value:g.password,onChange:e=>_({...g,password:e.target.value}),placeholder:e.id?`Deixe em branco para não alterar`:`Mínimo 6 caracteres`,required:!e.id}),(0,f.jsx)(`p`,{style:{fontSize:`0.75rem`,color:`#64748b`,marginTop:`0.25rem`},children:e.id?`Preencha apenas se desejar redefinir a senha do usuário.`:`Defina uma senha para o primeiro acesso.`})]}),(0,f.jsxs)(`div`,{className:`form-group`,children:[(0,f.jsx)(`label`,{className:`form-label`,children:`Empresa`}),(0,f.jsxs)(`select`,{className:`form-select`,value:g.empresa_id,onChange:e=>_({...g,empresa_id:e.target.value}),disabled:!m,style:m?{}:{backgroundColor:`#f1f5f9`,cursor:`not-allowed`},children:[(0,f.jsx)(`option`,{value:``,children:`Selecione uma empresa`}),t.map(e=>(0,f.jsx)(`option`,{value:e.id,children:e.nome},e.id))]})]}),(0,f.jsxs)(`div`,{className:`form-group`,children:[(0,f.jsx)(`label`,{className:`form-label`,children:`Perfil (Role)`}),(0,f.jsx)(`select`,{className:`form-select`,value:g.role,onChange:e=>_({...g,role:e.target.value}),disabled:!m&&!e.id,style:!m&&!e.id?{backgroundColor:`#f1f5f9`,cursor:`not-allowed`}:{},children:m?(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(`option`,{value:`super_admin`,children:`Super Admin (Global)`}),(0,f.jsx)(`option`,{value:`admin`,children:`Administrador (Empresa)`}),(0,f.jsx)(`option`,{value:`tecnico`,children:`Técnico`}),(0,f.jsx)(`option`,{value:`cliente`,children:`Cliente`})]}):(0,f.jsxs)(f.Fragment,{children:[e.role===`admin`&&(0,f.jsx)(`option`,{value:`admin`,children:`Administrador (Empresa)`}),(0,f.jsx)(`option`,{value:`tecnico`,children:`Técnico`}),e.role===`cliente`&&(0,f.jsx)(`option`,{value:`cliente`,children:`Cliente`})]})}),!m&&!e.id&&(0,f.jsx)(`p`,{style:{fontSize:`0.75rem`,color:`#64748b`,marginTop:`0.25rem`},children:`Como administrador de empresa, você só pode criar novos técnicos.`})]})]}),(0,f.jsxs)(`div`,{className:`modal-footer`,children:[(0,f.jsx)(`button`,{type:`button`,className:`btn-secondary`,onClick:n,children:`Cancelar`}),(0,f.jsx)(`button`,{type:`submit`,className:`btn-primary`,disabled:v,children:v?`Salvando...`:e.id?`Salvar Alterações`:u===`tecnico`?`Criar Técnico`:`Criar Usuário`})]})]})]})})}function y(){let{userProfile:e}=r(),t=e?.role===`super_admin`,[n,a]=(0,d.useState)(t?`empresas`:`usuarios`),[o,s]=(0,d.useState)([]),[c,l]=(0,d.useState)([]),[u,h]=(0,d.useState)([]),[y,b]=(0,d.useState)(!0),x=(0,d.useRef)(null),[S,C]=(0,d.useState)(!1),[w,T]=(0,d.useState)(null),[E,D]=(0,d.useState)(!1),[O,k]=(0,d.useState)(null),A=async()=>{b(!0);try{let[e,t]=await Promise.all([i.listarEmpresas(),i.listarUsuarios()]);s(e),l(t);try{h(await i.listarAuditoria())}catch(e){console.warn(`Logs de auditoria não disponíveis (verifique se rodou o SQL):`,e),h([])}}catch(e){console.error(`Erro ao carregar dados administrativos:`,e),alert(`Erro ao carregar empresas ou usuários. Verifique sua conexão.`)}finally{b(!1)}};(0,d.useEffect)(()=>{A(),window.location.hash===`#usuarios`?a(`usuarios`):window.location.hash===`#empresas`?a(`empresas`):window.location.hash===`#auditoria`&&a(`auditoria`)},[location.hash]),(0,d.useEffect)(()=>{if(x.current){let e=x.current.querySelector(`.admin-tab.active`);e&&e.scrollIntoView({behavior:`smooth`,inline:`center`,block:`nearest`})}},[n]);let j=()=>{T(null),C(!0)},M=e=>{T(e),C(!0)},N=()=>{C(!1),A()},P=e=>{k(e),D(!0)},F=()=>{D(!1),A()},I=async(e,t)=>{if(window.confirm(`Tem certeza que deseja excluir a empresa "${t}"? Esta ação é irreversível e afetará todos os usuários e dados vinculados.`))try{await i.excluirEmpresa(e),A()}catch(e){console.error(e),alert(`Erro ao excluir empresa. Verifique se existem vínculos ativos.`)}},L=async(e,t)=>{if(window.confirm(`Tem certeza que deseja remover o acesso de "${t}"?`))try{await i.excluirPerfil(e),A()}catch(e){console.error(e),alert(`Erro ao remover usuário.`)}},R=e=>{switch(e){case`INSERT`:return{label:`Criação`,color:`#059669`};case`UPDATE`:return{label:`Edição`,color:`#2563eb`};case`DELETE`:return{label:`Exclusão`,color:`#dc2626`};default:return{label:e,color:`#64748b`}}},z=e=>{switch(e){case`ordens_servico`:return`OS`;case`clientes`:return`Cliente`;case`orcamentos`:return`Orçamento`;case`produtos`:return`Produto`;default:return e}};return(0,f.jsxs)(`div`,{className:`admin-page`,children:[(0,f.jsxs)(`div`,{className:`admin-header`,children:[(0,f.jsx)(`h1`,{className:`admin-title`,children:t?`Administração Global`:`Administração da Empresa`}),n===`empresas`&&(0,f.jsxs)(`button`,{className:`btn-primary`,onClick:j,children:[(0,f.jsx)(p,{}),` Nova Empresa`]}),n===`usuarios`&&(0,f.jsxs)(`div`,{style:{display:`flex`,gap:`1rem`},children:[(0,f.jsx)(`span`,{style:{fontSize:`0.8rem`,color:`#64748b`,alignSelf:`center`},children:t?`Gerencie todos os usuários do sistema.`:`Gerencie os técnicos da sua empresa.`}),(0,f.jsxs)(`button`,{className:`btn-primary`,onClick:()=>{k({id:``,nome:``,empresa_id:``,role:`tecnico`}),D(!0)},children:[(0,f.jsx)(p,{}),` `,t?`Novo Usuário`:`Novo Técnico`]})]}),n===`auditoria`&&(0,f.jsx)(`button`,{className:`btn-secondary`,onClick:A,children:`Atualizar Logs`})]}),(0,f.jsxs)(`div`,{className:`admin-tabs horizontal-tabs-container hide-scrollbar`,ref:x,children:[t&&(0,f.jsx)(`div`,{className:`admin-tab ${n===`empresas`?`active`:``}`,onClick:()=>a(`empresas`),children:`Empresas`}),(0,f.jsx)(`div`,{className:`admin-tab ${n===`usuarios`?`active`:``}`,onClick:()=>a(`usuarios`),children:t?`Usuários`:`Equipe / Usuários`}),t&&(0,f.jsx)(`div`,{className:`admin-tab ${n===`auditoria`?`active`:``}`,onClick:()=>a(`auditoria`),children:`Auditoria`})]}),y?(0,f.jsx)(`div`,{children:`Carregando...`}):(0,f.jsxs)(`div`,{className:`admin-content`,children:[n===`empresas`&&(0,f.jsx)(`div`,{className:`admin-table-container`,children:(0,f.jsxs)(`table`,{className:`data-table`,children:[(0,f.jsx)(`thead`,{children:(0,f.jsxs)(`tr`,{children:[(0,f.jsx)(`th`,{children:`Nome`}),(0,f.jsx)(`th`,{children:`CNPJ`}),(0,f.jsx)(`th`,{children:`Email`}),(0,f.jsx)(`th`,{children:`Status`}),(0,f.jsx)(`th`,{children:`Ações`})]})}),(0,f.jsx)(`tbody`,{children:o.map(e=>(0,f.jsxs)(`tr`,{style:{opacity:e.ativo===!1?.6:1},children:[(0,f.jsx)(`td`,{style:{fontWeight:600},"data-label":`Nome`,children:e.nome}),(0,f.jsx)(`td`,{"data-label":`CNPJ`,children:e.cnpj||`-`}),(0,f.jsx)(`td`,{"data-label":`Email`,children:e.email||`-`}),(0,f.jsx)(`td`,{"data-label":`Status`,children:(0,f.jsx)(`span`,{className:`badge ${e.ativo===!1?`badge-danger`:`badge-success`}`,children:e.ativo===!1?`Bloqueada`:`Ativa`})}),(0,f.jsx)(`td`,{"data-label":`Ações`,children:(0,f.jsxs)(`div`,{style:{display:`flex`,gap:`0.5rem`},children:[(0,f.jsx)(`button`,{className:`btn-icon`,onClick:()=>M(e),title:`Editar`,children:(0,f.jsx)(m,{})}),(0,f.jsx)(`button`,{className:`btn-icon btn-icon-danger`,onClick:()=>I(e.id,e.nome),title:`Excluir`,children:(0,f.jsx)(g,{})})]})})]},e.id))})]})}),n===`usuarios`&&(0,f.jsx)(`div`,{className:`admin-table-container`,children:(0,f.jsxs)(`table`,{className:`data-table`,children:[(0,f.jsx)(`thead`,{children:(0,f.jsxs)(`tr`,{children:[(0,f.jsx)(`th`,{children:`Nome`}),(0,f.jsx)(`th`,{children:`E-mail`}),(0,f.jsx)(`th`,{children:`WhatsApp`}),(0,f.jsx)(`th`,{children:`Empresa`}),(0,f.jsx)(`th`,{children:`Perfil`}),(0,f.jsx)(`th`,{children:`Ações`})]})}),(0,f.jsx)(`tbody`,{children:c.map(e=>(0,f.jsxs)(`tr`,{children:[(0,f.jsx)(`td`,{style:{fontWeight:600},"data-label":`Nome`,children:e.nome}),(0,f.jsx)(`td`,{style:{fontSize:`0.85rem`},"data-label":`E-mail`,children:e.email||`-`}),(0,f.jsx)(`td`,{style:{fontSize:`0.85rem`},"data-label":`WhatsApp`,children:e.telefone||`-`}),(0,f.jsx)(`td`,{"data-label":`Empresa`,children:e.empresa?.nome||`-`}),(0,f.jsx)(`td`,{"data-label":`Perfil`,children:(0,f.jsx)(`span`,{className:`role-badge role-${e.role}`,children:e.role})}),(0,f.jsx)(`td`,{"data-label":`Ações`,children:(0,f.jsxs)(`div`,{style:{display:`flex`,gap:`0.5rem`},children:[(0,f.jsx)(`button`,{className:`btn-icon`,onClick:()=>P(e),title:`Editar Perfil`,children:(0,f.jsx)(m,{})}),(0,f.jsx)(`button`,{className:`btn-icon btn-icon-danger`,onClick:()=>L(e.id,e.nome),title:`Excluir`,children:(0,f.jsx)(g,{})})]})})]},e.id))})]})}),n===`auditoria`&&(0,f.jsx)(`div`,{className:`admin-table-container`,children:(0,f.jsxs)(`table`,{className:`data-table`,children:[(0,f.jsx)(`thead`,{children:(0,f.jsxs)(`tr`,{children:[(0,f.jsx)(`th`,{children:`Data/Hora`}),(0,f.jsx)(`th`,{children:`Usuário`}),(0,f.jsx)(`th`,{children:`Empresa`}),(0,f.jsx)(`th`,{children:`Ação`}),(0,f.jsx)(`th`,{children:`Tabela`}),(0,f.jsx)(`th`,{children:`Detalhes (JSON)`})]})}),(0,f.jsx)(`tbody`,{children:u.map(e=>(0,f.jsxs)(`tr`,{children:[(0,f.jsx)(`td`,{style:{fontSize:`0.8rem`},"data-label":`Data/Hora`,children:new Date(e.created_at).toLocaleString(`pt-BR`)}),(0,f.jsx)(`td`,{style:{fontWeight:600},"data-label":`Usuário`,children:e.perfil?.nome||`Sistema`}),(0,f.jsx)(`td`,{"data-label":`Empresa`,children:e.empresa?.nome||`-`}),(0,f.jsx)(`td`,{"data-label":`Ação`,children:(0,f.jsx)(`span`,{style:{color:R(e.acao).color,fontWeight:600,padding:`0.2rem 0.5rem`,borderRadius:`4px`,background:`${R(e.acao).color}15`},children:R(e.acao).label})}),(0,f.jsx)(`td`,{"data-label":`Tabela`,children:z(e.tabela)}),(0,f.jsx)(`td`,{"data-label":`Detalhes`,children:(0,f.jsx)(`button`,{className:`btn-secondary`,style:{fontSize:`0.7rem`,padding:`0.2rem 0.4rem`},onClick:()=>{let t={antes:e.dados_antigos,depois:e.dados_novos};alert(JSON.stringify(t,null,2))},children:`Ver Alterações`})})]},e.id))})]})})]}),S&&(0,f.jsx)(_,{empresa:w,onClose:()=>C(!1),onSave:N}),E&&O&&(0,f.jsx)(v,{usuario:O,empresas:o,onClose:()=>D(!1),onSave:F})]})}export{y as AdminPage,y as default};