import{c as e,n as t,o as n,r,t as i}from"./index-C9yBzEdM.js";var a=e(n(),1);const o={async listarCursos(e){let{data:n,error:r}=await t.from(`ec_cursos`).select(`*`).eq(`empresa_id`,e).eq(`ativo`,!0).order(`created_at`,{ascending:!1});if(r)throw r;return n},async obterCurso(e){let{data:n,error:r}=await t.from(`ec_cursos`).select(`*`).eq(`id`,e).single();if(r)throw r;let{data:i,error:a}=await t.from(`ec_aulas`).select(`*`).eq(`curso_id`,e).order(`ordem`,{ascending:!0});if(a)throw a;return{...n,aulas:i}},async registrarProgresso(e,n){let{error:r}=await t.from(`ec_progresso_tecnico`).upsert({perfil_id:e,aula_id:n,concluido:!0,data_conclusao:new Date().toISOString()},{onConflict:`perfil_id,aula_id`});if(r)throw r;await this.atualizarStatsAposAula(e,n)},async obterProgressoUsuario(e){let{data:n,error:r}=await t.from(`ec_progresso_tecnico`).select(`*`).eq(`perfil_id`,e);if(r)throw r;return n},async obterStatsTecnico(e,n){let{data:r,error:i}=await t.from(`ec_tecnico_stats`).select(`*`).eq(`perfil_id`,e).single();if(i&&i.code===`PGRST116`){let r={perfil_id:e,empresa_id:n,xp_total:0,nivel:1,moedas_aprendizado:0,cursos_concluidos:0},{data:i,error:a}=await t.from(`ec_tecnico_stats`).insert(r).select().single();if(a)throw a;return i}if(i)throw i;return r},async atualizarStatsAposAula(e,n){let{data:r}=await t.from(`ec_aulas`).select(`curso_id`).eq(`id`,n).single();if(!r)return;let{data:i}=await t.from(`ec_cursos`).select(`xp_recompensa, id`).eq(`id`,r.curso_id).single();if(!i)return;let{data:a}=await t.from(`ec_aulas`).select(`id`).eq(`curso_id`,i.id),{count:o}=await t.from(`ec_progresso_tecnico`).select(`*`,{count:`exact`,head:!0}).eq(`perfil_id`,e).in(`aula_id`,a?.map(e=>e.id)||[]);if(o===a?.length){let n=await this.obterStatsTecnico(e,``),r=n.xp_total+i.xp_recompensa,a=Math.floor(r/1e3)+1;await t.from(`ec_tecnico_stats`).update({xp_total:r,nivel:a,cursos_concluidos:n.cursos_concluidos+1,moedas_aprendizado:n.moedas_aprendizado+i.xp_recompensa/2}).eq(`perfil_id`,e),await this.checarEAtribuirBadges(e,n.empresa_id)}},async checarEAtribuirBadges(e,n){if((await this.obterStatsTecnico(e,n)).cursos_concluidos>=1){let{data:r}=await t.from(`ec_badges`).select(`id`).eq(`empresa_id`,n).eq(`tipo`,`primeiro_curso`).single();r&&await t.from(`ec_conquistas`).upsert({perfil_id:e,badge_id:r.id},{onConflict:`perfil_id,badge_id`})}},async listarConquistas(e){let{data:n,error:r}=await t.from(`ec_conquistas`).select(`*, badge:ec_badges(*)`).eq(`perfil_id`,e);if(r)throw r;return n},async salvarCurso(e){let{data:n,error:r}=await t.from(`ec_cursos`).upsert(e).select().single();if(r)throw r;return n},async salvarAula(e){let{data:n,error:r}=await t.from(`ec_aulas`).upsert(e).select().single();if(r)throw r;return n}};var s=r();function c(){let{userProfile:e}=i(),[t,n]=(0,a.useState)([]),[r,c]=(0,a.useState)(null),[l,u]=(0,a.useState)([]),[d,f]=(0,a.useState)([]),[p,m]=(0,a.useState)(!0),[h,g]=(0,a.useState)(`catalog`),[_,v]=(0,a.useState)(null),y=e?.empresa_id||``,b=e?.id||``,x=async()=>{if(!(!y||!b)){m(!0);try{let[e,t,r,i]=await Promise.all([o.listarCursos(y),o.obterStatsTecnico(b,y),o.listarConquistas(b),o.obterProgressoUsuario(b)]);n(e),c(t),u(r),f(i)}catch(e){console.error(e)}finally{m(!1)}}};(0,a.useEffect)(()=>{x()},[y,b]);let S=(r?.nivel||1)*1e3,C=r?r.xp_total%1e3/10:0;return p?(0,s.jsx)(`div`,{className:`educacao-page`,children:(0,s.jsx)(`div`,{className:`loading-spinner`,children:`Carregando Academia...`})}):(0,s.jsxs)(`div`,{className:`educacao-page`,children:[(0,s.jsxs)(`header`,{className:`educacao-header`,children:[(0,s.jsx)(`h1`,{className:`page-title`,children:`Academia de TÃ©cnicos`}),(0,s.jsx)(`p`,{className:`page-subtitle`,children:`Aprimore suas habilidades e conquiste novos nÃ­veis.`})]}),(0,s.jsxs)(`div`,{className:`gamificacao-bar`,children:[(0,s.jsxs)(`div`,{className:`stat-card`,children:[(0,s.jsx)(`div`,{className:`stat-icon`,children:`ðŸ†`}),(0,s.jsxs)(`div`,{className:`stat-info`,style:{flexGrow:1},children:[(0,s.jsxs)(`div`,{className:`label`,children:[`NÃ­vel `,r?.nivel]}),(0,s.jsxs)(`div`,{className:`value`,children:[r?.xp_total,` / `,S,` XP`]}),(0,s.jsx)(`div`,{className:`xp-progress-container`,children:(0,s.jsx)(`div`,{className:`xp-progress-fill`,style:{width:`${C}%`}})})]})]}),(0,s.jsxs)(`div`,{className:`stat-card`,children:[(0,s.jsx)(`div`,{className:`stat-icon`,children:`ðŸŽ“`}),(0,s.jsxs)(`div`,{className:`stat-info`,children:[(0,s.jsx)(`div`,{className:`label`,children:`Cursos ConcluÃ­dos`}),(0,s.jsx)(`div`,{className:`value`,children:r?.cursos_concluidos})]})]}),(0,s.jsxs)(`div`,{className:`stat-card`,children:[(0,s.jsx)(`div`,{className:`stat-icon`,children:`ðŸ’Ž`}),(0,s.jsxs)(`div`,{className:`stat-info`,children:[(0,s.jsx)(`div`,{className:`label`,children:`Moedas`}),(0,s.jsx)(`div`,{className:`value`,children:r?.moedas_aprendizado})]})]})]}),(0,s.jsxs)(`section`,{className:`catalog-section`,children:[(0,s.jsxs)(`div`,{className:`section-header`,style:{marginBottom:`1.5rem`,display:`flex`,justifyContent:`space-between`},children:[(0,s.jsx)(`h3`,{children:`Cursos DisponÃ­veis`}),(0,s.jsxs)(`div`,{className:`filters`,children:[(0,s.jsx)(`button`,{className:`btn-secondary`,style:{fontSize:`0.8rem`},children:`Todos`}),(0,s.jsx)(`button`,{className:`btn-secondary`,style:{fontSize:`0.8rem`,marginLeft:`0.5rem`},children:`SeguranÃ§a`})]})]}),(0,s.jsx)(`div`,{className:`courses-grid`,children:t.length===0?(0,s.jsx)(`div`,{className:`empty-state`,children:`Nenhum curso disponÃ­vel no momento.`}):t.map(e=>(0,s.jsxs)(`div`,{className:`course-card`,onClick:()=>{v(e),g(`player`)},children:[(0,s.jsxs)(`div`,{className:`course-capa`,children:[(0,s.jsx)(`span`,{className:`course-category`,children:e.categoria}),e.capa_url?(0,s.jsx)(`img`,{src:e.capa_url,alt:e.titulo}):`ðŸ“š`]}),(0,s.jsxs)(`div`,{className:`course-content`,children:[(0,s.jsx)(`h4`,{className:`course-title`,children:e.titulo}),(0,s.jsx)(`p`,{style:{fontSize:`0.85rem`,color:`#64748b`,lineClamp:2,overflow:`hidden`,display:`-webkit-box`,WebkitBoxOrient:`vertical`,WebkitLineClamp:2},children:e.descricao}),(0,s.jsxs)(`div`,{className:`course-meta`,children:[(0,s.jsxs)(`span`,{children:[`â±ï¸ `,Math.round(e.carga_horaria/60),`h`]}),(0,s.jsxs)(`span`,{className:`course-xp`,children:[`+`,e.xp_recompensa,` XP`]}),d.find(t=>t.aula_id===e.id)&&(0,s.jsx)(`span`,{style:{color:`#22c55e`},children:`âœ…`})]})]})]},e.id))})]}),(0,s.jsxs)(`section`,{className:`badges-section`,children:[(0,s.jsx)(`h3`,{children:`Minhas Conquistas`}),(0,s.jsxs)(`div`,{className:`badges-grid`,children:[(0,s.jsxs)(`div`,{className:`badge-item ${r?.cursos_concluidos&&r.cursos_concluidos>=1?`conquistado`:``}`,children:[(0,s.jsx)(`div`,{className:`badge-icon`,children:`ðŸŽ¯`}),(0,s.jsx)(`div`,{className:`badge-name`,children:`Primeiro Passo`})]}),(0,s.jsxs)(`div`,{className:`badge-item ${r?.nivel&&r.nivel>=5?`conquistado`:``}`,children:[(0,s.jsx)(`div`,{className:`badge-icon`,children:`ðŸ”¥`}),(0,s.jsx)(`div`,{className:`badge-name`,children:`Veterano`})]}),l.map(e=>(0,s.jsxs)(`div`,{className:`badge-item conquistado`,children:[(0,s.jsx)(`div`,{className:`badge-icon`,children:e.badge?.icone}),(0,s.jsx)(`div`,{className:`badge-name`,children:e.badge?.nome})]},e.id))]})]})]})}export{c as EducacaoPage,c as default};