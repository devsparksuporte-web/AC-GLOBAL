import{c as e,n as t,o as n,r,t as i}from"./index-C9yBzEdM.js";/* empty css                 */import{t as a}from"./clientesService-BnZzC_Tg.js";var o=e(n(),1);const s={async obterPrograma(e){let{data:n,error:r}=await t.from(`programas_fidelidade`).select(`*`).eq(`empresa_id`,e).maybeSingle();if(r)throw r;return n},async salvarPrograma(e){let{data:n,error:r}=await t.from(`programas_fidelidade`).upsert(e).select().single();if(r)throw r;return n},async listarPontosClientes(e){let{data:n,error:r}=await t.from(`pontos_cliente`).select(`*, cliente:clientes(nome)`).eq(`empresa_id`,e).order(`pontos_atuais`,{ascending:!1});if(r)throw r;return n||[]},async creditarPontos(e){let{data:{user:n}}=await t.auth.getUser();if(!n)throw Error(`UsuÃ¡rio nÃ£o autenticado`);let{error:r}=await t.from(`transacoes_pontos`).insert({...e,criado_por:n.id});if(r)throw r;let{data:i}=await t.from(`pontos_cliente`).select(`*`).eq(`cliente_id`,e.cliente_id).eq(`empresa_id`,e.empresa_id).maybeSingle();if(i){let n=(i.pontos_atuais||0)+(e.pontos||0),r=(i.pontos_totais_acumulados||0)+(e.pontos>0?e.pontos:0);await t.from(`pontos_cliente`).update({pontos_atuais:n,pontos_totais_acumulados:r}).eq(`id`,i.id)}else await t.from(`pontos_cliente`).insert({empresa_id:e.empresa_id,cliente_id:e.cliente_id,pontos_atuais:e.pontos,pontos_totais_acumulados:e.pontos>0?e.pontos:0})},async listarIndicacoes(e){let{data:n,error:r}=await t.from(`indicacoes`).select(`*, indicador:clientes(nome)`).eq(`empresa_id`,e).order(`created_at`,{ascending:!1});if(r)throw r;return n||[]},async criarIndicacao(e){let{data:n,error:r}=await t.from(`indicacoes`).insert(e).select().single();if(r)throw r;return n},async atualizarStatusIndicacao(e,n){let{error:r}=await t.from(`indicacoes`).update({status:n}).eq(`id`,e);if(r)throw r},async listarDescontos(e){let{data:n,error:r}=await t.from(`descontos_preventiva`).select(`*`).eq(`empresa_id`,e).order(`min_manutencoes`,{ascending:!0});if(r)throw r;return n||[]},async salvarDesconto(e){let{data:n,error:r}=await t.from(`descontos_preventiva`).upsert(e).select().single();if(r)throw r;return n},async excluirDesconto(e){let{error:n}=await t.from(`descontos_preventiva`).delete().eq(`id`,e);if(n)throw n},async listarResgates(e){let{data:n,error:r}=await t.from(`resgates`).select(`*, cliente:clientes(nome)`).eq(`empresa_id`,e).order(`created_at`,{ascending:!1});if(r)throw r;return n||[]},async criarResgate(e){let{data:n,error:r}=await t.from(`resgates`).insert(e).select().single();if(r)throw r;return await this.creditarPontos({empresa_id:e.empresa_id,cliente_id:e.cliente_id,pontos:-(e.pontos_utilizados||0),tipo:`resgate`,referencia_id:n.id,descricao:`Resgate de ${e.tipo_resgate}`}),n}};var c=r(),l=()=>(0,c.jsxs)(`svg`,{width:`20`,height:`20`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,c.jsx)(`line`,{x1:`12`,y1:`5`,x2:`12`,y2:`19`}),(0,c.jsx)(`line`,{x1:`5`,y1:`12`,x2:`19`,y2:`12`})]}),u=()=>(0,c.jsxs)(`svg`,{width:`18`,height:`18`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,c.jsx)(`circle`,{cx:`12`,cy:`12`,r:`3`}),(0,c.jsx)(`path`,{d:`M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z`})]});function d({empresaId:e,onClose:t,onSave:n}){let[r,i]=(0,o.useState)([]),[l,u]=(0,o.useState)(``),[d,f]=(0,o.useState)(0),[p,m]=(0,o.useState)(``),[h,g]=(0,o.useState)(!1),[_,v]=(0,o.useState)(``);return(0,o.useEffect)(()=>{a.listar().then(i)},[]),(0,c.jsx)(`div`,{className:`modal-overlay`,onClick:t,children:(0,c.jsxs)(`div`,{className:`modal-content`,onClick:e=>e.stopPropagation(),children:[(0,c.jsxs)(`div`,{className:`modal-header`,children:[(0,c.jsx)(`h2`,{className:`modal-title`,children:`Creditar Pontos Bonus`}),(0,c.jsx)(`button`,{className:`modal-close`,onClick:t,children:`âœ•`})]}),(0,c.jsxs)(`form`,{onSubmit:async t=>{if(t.preventDefault(),!l||d<=0){v(`Selecione um cliente e informe os pontos.`);return}g(!0),v(``);try{await s.creditarPontos({empresa_id:e,cliente_id:l,pontos:d,tipo:`bonus`,descricao:p}),n()}catch{v(`Erro ao creditar pontos.`)}finally{g(!1)}},children:[(0,c.jsxs)(`div`,{className:`modal-body`,children:[_&&(0,c.jsx)(`div`,{className:`error-message`,children:_}),(0,c.jsxs)(`div`,{className:`form-group`,children:[(0,c.jsx)(`label`,{className:`form-label`,children:`Cliente *`}),(0,c.jsxs)(`select`,{className:`form-select`,value:l,onChange:e=>u(e.target.value),required:!0,children:[(0,c.jsx)(`option`,{value:``,children:`Selecione um cliente`}),r.map(e=>(0,c.jsx)(`option`,{value:e.id,children:e.nome},e.id))]})]}),(0,c.jsxs)(`div`,{className:`form-group`,children:[(0,c.jsx)(`label`,{className:`form-label`,children:`Quantidade de Pontos *`}),(0,c.jsx)(`input`,{className:`form-input`,type:`number`,min:1,value:d,onChange:e=>f(Number(e.target.value)),required:!0})]}),(0,c.jsxs)(`div`,{className:`form-group`,children:[(0,c.jsx)(`label`,{className:`form-label`,children:`Motivo / DescriÃ§Ã£o`}),(0,c.jsx)(`input`,{className:`form-input`,value:p,onChange:e=>m(e.target.value),placeholder:`Ex: BÃ´nus de aniversÃ¡rio`})]})]}),(0,c.jsxs)(`div`,{className:`modal-footer`,children:[(0,c.jsx)(`button`,{type:`button`,className:`btn-secondary`,onClick:t,children:`Cancelar`}),(0,c.jsx)(`button`,{type:`submit`,className:`btn-primary`,disabled:h,children:`Creditar`})]})]})]})})}function f({programa:e,onSave:t,onClose:n}){let[r,i]=(0,o.useState)(e||{pontos_por_real:1,valor_ponto_resgate:.05,pontos_minimos_resgate:100,pontos_por_indicacao:500,ativo:!0});return(0,c.jsx)(`div`,{className:`modal-overlay`,onClick:n,children:(0,c.jsxs)(`div`,{className:`modal-content`,onClick:e=>e.stopPropagation(),children:[(0,c.jsxs)(`div`,{className:`modal-header`,children:[(0,c.jsx)(`h2`,{className:`modal-title`,children:`Configurar Programa`}),(0,c.jsx)(`button`,{className:`modal-close`,onClick:n,children:`âœ•`})]}),(0,c.jsxs)(`div`,{className:`modal-body`,children:[(0,c.jsxs)(`div`,{className:`form-row`,children:[(0,c.jsxs)(`div`,{className:`form-group`,children:[(0,c.jsx)(`label`,{className:`form-label`,children:`Pontos por R$ 1,00`}),(0,c.jsx)(`input`,{className:`form-input`,type:`number`,step:`0.1`,value:r.pontos_por_real,onChange:e=>i({...r,pontos_por_real:Number(e.target.value)})})]}),(0,c.jsxs)(`div`,{className:`form-group`,children:[(0,c.jsx)(`label`,{className:`form-label`,children:`Valor do Ponto (R$)`}),(0,c.jsx)(`input`,{className:`form-input`,type:`number`,step:`0.001`,value:r.valor_ponto_resgate,onChange:e=>i({...r,valor_ponto_resgate:Number(e.target.value)})})]})]}),(0,c.jsxs)(`div`,{className:`form-row`,children:[(0,c.jsxs)(`div`,{className:`form-group`,children:[(0,c.jsx)(`label`,{className:`form-label`,children:`MÃ­nimo p/ Resgate`}),(0,c.jsx)(`input`,{className:`form-input`,type:`number`,value:r.pontos_minimos_resgate,onChange:e=>i({...r,pontos_minimos_resgate:Number(e.target.value)})})]}),(0,c.jsxs)(`div`,{className:`form-group`,children:[(0,c.jsx)(`label`,{className:`form-label`,children:`Pontos por IndicaÃ§Ã£o`}),(0,c.jsx)(`input`,{className:`form-input`,type:`number`,value:r.pontos_por_indicacao,onChange:e=>i({...r,pontos_por_indicacao:Number(e.target.value)})})]})]}),(0,c.jsxs)(`div`,{className:`form-group`,style:{flexDirection:`row`,alignItems:`center`,gap:`0.75rem`},children:[(0,c.jsx)(`input`,{type:`checkbox`,id:`ativo`,checked:r.ativo,onChange:e=>i({...r,ativo:e.target.checked})}),(0,c.jsx)(`label`,{htmlFor:`ativo`,className:`form-label`,style:{marginBottom:0},children:`Programa Ativo`})]})]}),(0,c.jsxs)(`div`,{className:`modal-footer`,children:[(0,c.jsx)(`button`,{type:`button`,className:`btn-secondary`,onClick:n,children:`Cancelar`}),(0,c.jsx)(`button`,{type:`button`,className:`btn-primary`,onClick:()=>t(r),children:`Salvar ConfiguraÃ§Ãµes`})]})]})})}function p({empresaId:e,onClose:t,onSave:n}){let[r,i]=(0,o.useState)(5),[a,l]=(0,o.useState)(10),[u,d]=(0,o.useState)(``),[f,p]=(0,o.useState)(!1);return(0,c.jsx)(`div`,{className:`modal-overlay`,onClick:t,children:(0,c.jsxs)(`div`,{className:`modal-content`,onClick:e=>e.stopPropagation(),children:[(0,c.jsxs)(`div`,{className:`modal-header`,children:[(0,c.jsx)(`h2`,{className:`modal-title`,children:`Nova Regra de Desconto`}),(0,c.jsx)(`button`,{className:`modal-close`,onClick:t,children:`âœ•`})]}),(0,c.jsxs)(`form`,{onSubmit:async t=>{t.preventDefault(),p(!0);try{await s.salvarDesconto({empresa_id:e,min_manutencoes:r,percentual_desconto:a,descricao:u}),n()}catch(e){console.error(e)}finally{p(!1)}},children:[(0,c.jsxs)(`div`,{className:`modal-body`,children:[(0,c.jsxs)(`div`,{className:`form-group`,children:[(0,c.jsx)(`label`,{className:`form-label`,children:`MÃ­nimo de ManutenÃ§Ãµes`}),(0,c.jsx)(`input`,{className:`form-input`,type:`number`,value:r,onChange:e=>i(Number(e.target.value)),required:!0})]}),(0,c.jsxs)(`div`,{className:`form-group`,children:[(0,c.jsx)(`label`,{className:`form-label`,children:`Percentual de Desconto (%)`}),(0,c.jsx)(`input`,{className:`form-input`,type:`number`,value:a,onChange:e=>l(Number(e.target.value)),required:!0})]}),(0,c.jsxs)(`div`,{className:`form-group`,children:[(0,c.jsx)(`label`,{className:`form-label`,children:`DescriÃ§Ã£o`}),(0,c.jsx)(`input`,{className:`form-input`,value:u,onChange:e=>d(e.target.value),placeholder:`Ex: Cliente Fiel Silver`})]})]}),(0,c.jsxs)(`div`,{className:`modal-footer`,children:[(0,c.jsx)(`button`,{type:`button`,className:`btn-secondary`,onClick:t,children:`Cancelar`}),(0,c.jsx)(`button`,{type:`submit`,className:`btn-primary`,disabled:f,children:`Salvar Regra`})]})]})]})})}function m(){let{userProfile:e}=i(),[t,n]=(0,o.useState)(`pontos`),[r,a]=(0,o.useState)(null),[m,h]=(0,o.useState)([]),[g,_]=(0,o.useState)([]),[v,y]=(0,o.useState)([]),[b,x]=(0,o.useState)(!0),[S,C]=(0,o.useState)(!1),[w,T]=(0,o.useState)(!1),[E,D]=(0,o.useState)(!1),O=e?.empresa_id||``,k=async()=>{if(O){x(!0);try{let[e,t,n,r]=await Promise.all([s.obterPrograma(O),s.listarPontosClientes(O),s.listarIndicacoes(O),s.listarDescontos(O)]);a(e),h(t),_(n),y(r)}catch(e){console.error(e)}finally{x(!1)}}};(0,o.useEffect)(()=>{k()},[O]);let A=async e=>{try{await s.salvarPrograma({...e,empresa_id:O}),C(!1),k()}catch(e){console.error(e)}},j=async e=>{if(r)try{await s.creditarPontos({empresa_id:O,cliente_id:e.indicador_id,pontos:r.pontos_por_indicacao,tipo:`indicacao`,referencia_id:e.id,descricao:`Recompensa por indicar ${e.nome_indicado}`}),await s.atualizarStatusIndicacao(e.id,`recompensada`),k()}catch(e){console.error(e)}};return b?(0,c.jsx)(`div`,{className:`fidelidade-page`,children:(0,c.jsx)(`div`,{className:`loading-spinner`,children:(0,c.jsx)(`div`,{className:`spinner`})})}):(0,c.jsxs)(`div`,{className:`fidelidade-page`,children:[(0,c.jsxs)(`div`,{className:`page-header`,children:[(0,c.jsx)(`h1`,{className:`page-title`,children:`Programa de Fidelidade`}),(0,c.jsxs)(`div`,{className:`header-actions`,children:[(0,c.jsxs)(`button`,{className:`btn-secondary`,onClick:()=>C(!0),children:[(0,c.jsx)(u,{}),` Configurar`]}),t===`pontos`&&(0,c.jsxs)(`button`,{className:`btn-primary`,onClick:()=>T(!0),children:[(0,c.jsx)(l,{}),` Bonus`]})]})]}),(0,c.jsxs)(`div`,{className:`fidelidade-tabs`,children:[(0,c.jsx)(`button`,{className:`fidelidade-tab ${t===`pontos`?`active`:``}`,onClick:()=>n(`pontos`),children:`â­ Pontos`}),(0,c.jsx)(`button`,{className:`fidelidade-tab ${t===`indicacoes`?`active`:``}`,onClick:()=>n(`indicacoes`),children:`ðŸ¤ IndicaÃ§Ãµes`}),(0,c.jsx)(`button`,{className:`fidelidade-tab ${t===`descontos`?`active`:``}`,onClick:()=>n(`descontos`),children:`ðŸ”§ ManutenÃ§Ã£o`})]}),t===`pontos`&&(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(`div`,{className:`fidelidade-metrics`,children:[(0,c.jsxs)(`div`,{className:`fidelidade-card`,children:[(0,c.jsx)(`div`,{className:`fidelidade-icon`,children:`ðŸ‘¥`}),(0,c.jsx)(`div`,{className:`fidelidade-value blue`,children:m.length}),(0,c.jsx)(`div`,{className:`fidelidade-label`,children:`Clientes Ativos`})]}),(0,c.jsxs)(`div`,{className:`fidelidade-card`,children:[(0,c.jsx)(`div`,{className:`fidelidade-icon`,children:`ðŸŒŸ`}),(0,c.jsx)(`div`,{className:`fidelidade-value gold`,children:m.reduce((e,t)=>e+t.pontos_atuais,0)}),(0,c.jsx)(`div`,{className:`fidelidade-label`,children:`Pontos Circulantes`})]}),(0,c.jsxs)(`div`,{className:`fidelidade-card`,children:[(0,c.jsx)(`div`,{className:`fidelidade-icon`,children:`ðŸ’°`}),(0,c.jsx)(`div`,{className:`fidelidade-value green`,children:r?.pontos_por_real||0}),(0,c.jsx)(`div`,{className:`fidelidade-label`,children:`Pnt / R$`})]})]}),(0,c.jsx)(`h3`,{style:{marginBottom:`1rem`,color:`var(--color-gray-700)`},children:`Ranking de Fidelidade`}),m.length===0?(0,c.jsx)(`div`,{className:`empty-state`,children:`Nenhum ponto registrado ainda.`}):m.map((e,t)=>(0,c.jsxs)(`div`,{className:`ranking-card`,children:[(0,c.jsxs)(`div`,{className:`ranking-info`,children:[(0,c.jsx)(`div`,{className:`ranking-position ${t<3?`top-${t+1}`:``}`,children:t+1}),(0,c.jsxs)(`div`,{children:[(0,c.jsx)(`div`,{style:{fontWeight:600},children:e.cliente?.nome}),(0,c.jsxs)(`div`,{style:{fontSize:`0.8rem`,color:`#64748b`},children:[`Acumulou `,e.pontos_totais_acumulados,` pontos no total`]})]})]}),(0,c.jsxs)(`div`,{style:{textAlign:`right`},children:[(0,c.jsx)(`div`,{className:`fidelidade-value gold`,style:{fontSize:`1.25rem`},children:e.pontos_atuais}),(0,c.jsx)(`div`,{style:{fontSize:`0.75rem`,color:`#94a3b8`},children:`pontos disponÃ­veis`})]})]},e.id))]}),t===`indicacoes`&&(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(`h3`,{style:{marginBottom:`1rem`,color:`var(--color-gray-700)`},children:`Rastreamento de IndicaÃ§Ãµes`}),(0,c.jsx)(`div`,{className:`table-container`,children:(0,c.jsxs)(`table`,{className:`data-table`,children:[(0,c.jsx)(`thead`,{children:(0,c.jsxs)(`tr`,{children:[(0,c.jsx)(`th`,{children:`Indicado`}),(0,c.jsx)(`th`,{children:`Quem Indicou`}),(0,c.jsx)(`th`,{children:`Contato`}),(0,c.jsx)(`th`,{children:`Status`}),(0,c.jsx)(`th`,{children:`AÃ§Ãµes`})]})}),(0,c.jsx)(`tbody`,{children:g.map(e=>(0,c.jsxs)(`tr`,{children:[(0,c.jsx)(`td`,{style:{fontWeight:600},children:e.nome_indicado}),(0,c.jsx)(`td`,{children:e.indicador?.nome}),(0,c.jsx)(`td`,{children:e.contato_indicado}),(0,c.jsx)(`td`,{children:(0,c.jsx)(`span`,{className:`indicacao-status ${e.status}`,children:e.status})}),(0,c.jsxs)(`td`,{children:[e.status===`pendente`&&(0,c.jsx)(`button`,{className:`btn-secondary`,style:{padding:`0.2rem 0.5rem`,fontSize:`0.75rem`},onClick:()=>s.atualizarStatusIndicacao(e.id,`confirmada`).then(k),children:`Confirmar`}),e.status===`confirmada`&&(0,c.jsx)(`button`,{className:`btn-primary`,style:{padding:`0.2rem 0.5rem`,fontSize:`0.75rem`},onClick:()=>j(e),children:`Recompensar`})]})]},e.id))})]})})]}),t===`descontos`&&(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`,alignItems:`center`,marginBottom:`1rem`},children:[(0,c.jsx)(`h3`,{style:{color:`var(--color-gray-700)`},children:`BenefÃ­cios por RecorrÃªncia`}),(0,c.jsxs)(`button`,{className:`btn-primary`,onClick:()=>D(!0),children:[(0,c.jsx)(l,{}),` Nova Regra`]})]}),(0,c.jsx)(`p`,{style:{fontSize:`0.9rem`,color:`#64748b`,marginBottom:`1.5rem`},children:`Defina descontos automÃ¡ticos para clientes que mantÃ©m manutenÃ§Ã£o preventiva regular.`}),v.map(e=>(0,c.jsxs)(`div`,{className:`rule-card`,children:[(0,c.jsxs)(`div`,{children:[(0,c.jsxs)(`div`,{className:`rule-title`,children:[e.percentual_desconto,`% de Desconto`]}),(0,c.jsxs)(`div`,{className:`rule-desc`,children:[`A partir de `,e.min_manutencoes,` manutenÃ§Ãµes concluÃ­das`]}),e.descricao&&(0,c.jsx)(`div`,{style:{fontSize:`0.8rem`,fontStyle:`italic`,marginTop:`0.25rem`},children:e.descricao})]}),(0,c.jsx)(`button`,{className:`btn-secondary`,style:{color:`#dc2626`},onClick:()=>s.excluirDesconto(e.id).then(k),children:`Excluir`})]},e.id)),v.length===0&&(0,c.jsxs)(`div`,{className:`empty-state`,style:{border:`2px dashed #e2e8f0`,borderRadius:`12px`,padding:`3rem`},children:[(0,c.jsx)(`div`,{style:{fontSize:`2rem`,marginBottom:`1rem`},children:`ðŸ“‰`}),(0,c.jsx)(`h4`,{children:`Nenhuma regra de desconto recorrente`}),(0,c.jsx)(`p`,{children:`Crie regras para incentivar contratos de manutenÃ§Ã£o.`})]})]}),S&&(0,c.jsx)(f,{programa:r,onClose:()=>C(!1),onSave:A}),w&&(0,c.jsx)(d,{empresaId:O,onClose:()=>T(!1),onSave:()=>{T(!1),k()}}),E&&(0,c.jsx)(p,{empresaId:O,onClose:()=>D(!1),onSave:()=>{D(!1),k()}})]})}export{m as FidelidadePage,m as default};