import{c as e,n as t,o as n,r,t as i}from"./index-C9yBzEdM.js";/* empty css                 */var a=e(n(),1);const o={async listar(){let{data:e,error:n}=await t.from(`fornecedores`).select(`*`).order(`nome`,{ascending:!0});if(n)throw n;return e||[]},async buscarPorId(e){let{data:n,error:r}=await t.from(`fornecedores`).select(`*`).eq(`id`,e).single();if(r)throw r;return n},async criar(e){let{data:{user:n}}=await t.auth.getUser(),{data:r}=await t.from(`perfis`).select(`empresa_id`).eq(`id`,n?.id).single();if(!r?.empresa_id)throw Error(`Empresa nÃ£o encontrada`);let{data:i,error:a}=await t.from(`fornecedores`).insert([{...e,empresa_id:r.empresa_id}]).select().single();if(a)throw a;return i},async atualizar(e,n){let{data:r,error:i}=await t.from(`fornecedores`).update(n).eq(`id`,e).select().single();if(i)throw i;return r},async excluir(e){let{error:n}=await t.from(`fornecedores`).delete().eq(`id`,e);if(n)throw n},async listarPedidos(e){let n=t.from(`pedidos_compra`).select(`
                *,
                fornecedor:fornecedores(id, nome, telefone, email)
            `).order(`created_at`,{ascending:!1});e&&(n=n.eq(`fornecedor_id`,e));let{data:r,error:i}=await n;if(i)throw i;return r||[]},async buscarPedidoPorId(e){let{data:n,error:r}=await t.from(`pedidos_compra`).select(`
                *,
                fornecedor:fornecedores(*)
            `).eq(`id`,e).single();if(r)throw r;return n},async criarPedido(e){let{data:{user:n}}=await t.auth.getUser(),{data:r}=await t.from(`perfis`).select(`empresa_id`).eq(`id`,n?.id).single();if(!r?.empresa_id)throw Error(`Empresa nÃ£o encontrada`);let{data:i,error:a}=await t.from(`pedidos_compra`).insert([{...e,empresa_id:r.empresa_id}]).select().single();if(a)throw a;return i},async atualizarPedido(e,n){let{data:r,error:i}=await t.from(`pedidos_compra`).update(n).eq(`id`,e).select().single();if(i)throw i;return r},async excluirPedido(e){let{error:n}=await t.from(`pedidos_compra`).delete().eq(`id`,e);if(n)throw n},async listarItensPedido(e){let{data:n,error:r}=await t.from(`itens_pedido_compra`).select(`*`).eq(`pedido_id`,e).order(`created_at`,{ascending:!0});if(r)throw r;return n||[]},async adicionarItemPedido(e){let{data:{user:n}}=await t.auth.getUser(),{data:r}=await t.from(`perfis`).select(`empresa_id`).eq(`id`,n?.id).single(),{data:i,error:a}=await t.from(`itens_pedido_compra`).insert([{...e,empresa_id:r?.empresa_id}]).select().single();if(a)throw a;return await this.recalcularTotalPedido(e.pedido_id),i},async removerItemPedido(e,n){let{error:r}=await t.from(`itens_pedido_compra`).delete().eq(`id`,e);if(r)throw r;await this.recalcularTotalPedido(n)},async recalcularTotalPedido(e){let{data:n,error:r}=await t.from(`itens_pedido_compra`).select(`quantidade, preco_unitario`).eq(`pedido_id`,e);if(r)throw r;let i=(n||[]).reduce((e,t)=>e+t.quantidade*t.preco_unitario,0),{error:a}=await t.from(`pedidos_compra`).update({valor_total:i}).eq(`id`,e);if(a)throw a}};var s=r();function c(){let{userProfile:e}=i(),[t,n]=(0,a.useState)([]),[r,c]=(0,a.useState)(!0),[l,u]=(0,a.useState)(!1),[d,f]=(0,a.useState)(null),[p,m]=(0,a.useState)(null),[h,g]=(0,a.useState)([]),[_,v]=(0,a.useState)(!1),[y,b]=(0,a.useState)(null),[x,S]=(0,a.useState)([]),C=async()=>{try{c(!0),n(await o.listar())}catch(e){console.error(`Erro ao carregar fornecedores:`,e)}finally{c(!1)}},w=async e=>{try{g(await o.listarPedidos(e))}catch(e){console.error(`Erro ao carregar pedidos:`,e)}};(0,a.useEffect)(()=>{C()},[]);let T=async e=>{if(e.preventDefault(),d?.nome)try{d.id?await o.atualizar(d.id,d):await o.criar(d),u(!1),C()}catch(e){console.error(`Erro ao salvar fornecedor:`,e),alert(`Erro ao salvar fornecedor`)}},E=async()=>{if(!(!p||x.length===0))try{let e=await o.criarPedido({fornecedor_id:p.id,status:`pendente`,valor_total:0,observacoes:y?.observacoes||``});await Promise.all(x.map(t=>o.adicionarItemPedido({pedido_id:e.id,nome:t.nome||``,quantidade:t.quantidade||0,preco_unitario:t.preco_unitario||0}))),v(!1),S([]),w(p.id)}catch(e){console.error(`Erro ao salvar pedido:`,e),alert(`Erro ao salvar pedido`)}},D=(t,n)=>{let r=`*PEDIDO DE COMPRA - ${e?.empresa?.nome||`AC Global`}*\n\n`;r+=`*Fornecedor:* ${t.fornecedor?.nome}\n`,r+=`*Data:* ${new Date(t.created_at).toLocaleDateString()}\n\n`,r+=`*Itens:*
`,n.forEach(e=>{r+=`- ${e.nome}: ${e.quantidade} x R$ ${e.preco_unitario.toFixed(2)} = R$ ${e.total.toFixed(2)}\n`}),r+=`\n*VALOR TOTAL:* R$ ${t.valor_total.toFixed(2)}\n`,t.observacoes&&(r+=`\n*Obs:* ${t.observacoes}`);let i=`https://wa.me/${t.fornecedor?.telefone?.replace(/\D/g,``)}?text=${encodeURIComponent(r)}`;window.open(i,`_blank`)};return(0,s.jsxs)(`div`,{className:`clientes-page`,children:[` `,(0,s.jsxs)(`div`,{className:`page-header`,children:[(0,s.jsx)(`h1`,{className:`page-title`,children:`Fornecedores`}),(0,s.jsx)(`button`,{className:`btn-primary`,onClick:()=>{f({}),u(!0)},children:`+ Novo Fornecedor`})]}),r?(0,s.jsx)(`div`,{className:`loading`,children:`Carregando fornecedores...`}):(0,s.jsx)(`div`,{className:`table-container shadow-premium`,children:(0,s.jsxs)(`table`,{className:`data-table`,children:[(0,s.jsx)(`thead`,{children:(0,s.jsxs)(`tr`,{children:[(0,s.jsx)(`th`,{children:`Nome`}),(0,s.jsx)(`th`,{children:`Contato`}),(0,s.jsx)(`th`,{children:`LocalizaÃ§Ã£o`}),(0,s.jsx)(`th`,{children:`AÃ§Ãµes`})]})}),(0,s.jsx)(`tbody`,{children:t.map(e=>(0,s.jsxs)(`tr`,{onClick:()=>{m(e),w(e.id)},style:{cursor:`pointer`},children:[(0,s.jsxs)(`td`,{children:[(0,s.jsx)(`div`,{style:{fontWeight:600},children:e.nome}),(0,s.jsx)(`div`,{style:{fontSize:`0.75rem`,color:`#64748b`},children:e.cnpj||`Sem CNPJ`})]}),(0,s.jsxs)(`td`,{children:[(0,s.jsx)(`div`,{children:e.telefone||`Sem telefone`}),(0,s.jsx)(`div`,{style:{fontSize:`0.75rem`,color:`#64748b`},children:e.email})]}),(0,s.jsxs)(`td`,{children:[e.cidade,` / `,e.estado]}),(0,s.jsx)(`td`,{children:(0,s.jsx)(`button`,{className:`btn-icon`,onClick:t=>{t.stopPropagation(),f(e),u(!0)},children:`âœï¸`})})]},e.id))})]})}),p&&(0,s.jsxs)(`div`,{className:`details-section shadow-premium`,style:{marginTop:`2rem`,background:`white`,padding:`1.5rem`,borderRadius:`1rem`},children:[(0,s.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`,alignItems:`center`,marginBottom:`1.5rem`},children:[(0,s.jsxs)(`h2`,{children:[`HistÃ³rico de Pedidos: `,p.nome]}),(0,s.jsx)(`button`,{className:`btn-primary`,onClick:()=>v(!0),children:`+ Novo Pedido`})]}),(0,s.jsxs)(`table`,{className:`data-table`,children:[(0,s.jsx)(`thead`,{children:(0,s.jsxs)(`tr`,{children:[(0,s.jsx)(`th`,{children:`Data`}),(0,s.jsx)(`th`,{children:`Status`}),(0,s.jsx)(`th`,{children:`Valor Total`}),(0,s.jsx)(`th`,{children:`AÃ§Ãµes`})]})}),(0,s.jsx)(`tbody`,{children:h.map(e=>(0,s.jsxs)(`tr`,{children:[(0,s.jsx)(`td`,{children:new Date(e.created_at).toLocaleDateString()}),(0,s.jsx)(`td`,{children:(0,s.jsx)(`span`,{className:`status-badge status-${e.status}`,children:e.status.charAt(0).toUpperCase()+e.status.slice(1)})}),(0,s.jsxs)(`td`,{children:[`R$ `,e.valor_total.toFixed(2)]}),(0,s.jsxs)(`td`,{children:[(0,s.jsx)(`button`,{className:`btn-icon`,title:`WhatsApp`,onClick:async()=>{D(e,await o.listarItensPedido(e.id))},children:`ðŸ“±`}),(0,s.jsx)(`button`,{className:`btn-icon`,title:`Imprimir/PDF`,onClick:()=>window.print(),children:`PDF`})]})]},e.id))})]})]}),l&&(0,s.jsx)(`div`,{className:`modal-overlay`,children:(0,s.jsxs)(`div`,{className:`modal-content`,children:[(0,s.jsxs)(`div`,{className:`modal-header`,children:[(0,s.jsx)(`h2`,{className:`modal-title`,children:d?.id?`Editar Fornecedor`:`Novo Fornecedor`}),(0,s.jsx)(`button`,{className:`modal-close`,onClick:()=>u(!1),children:`Ã—`})]}),(0,s.jsxs)(`form`,{onSubmit:T,children:[(0,s.jsxs)(`div`,{className:`modal-body`,children:[(0,s.jsxs)(`div`,{className:`form-group`,children:[(0,s.jsx)(`label`,{className:`form-label`,children:`Nome Fantasia`}),(0,s.jsx)(`input`,{className:`form-input`,value:d?.nome||``,onChange:e=>f({...d,nome:e.target.value}),required:!0})]}),(0,s.jsxs)(`div`,{className:`form-row`,children:[(0,s.jsxs)(`div`,{className:`form-group`,children:[(0,s.jsx)(`label`,{className:`form-label`,children:`CNPJ`}),(0,s.jsx)(`input`,{className:`form-input`,value:d?.cnpj||``,onChange:e=>f({...d,cnpj:e.target.value})})]}),(0,s.jsxs)(`div`,{className:`form-group`,children:[(0,s.jsx)(`label`,{className:`form-label`,children:`Telefone (WhatsApp)`}),(0,s.jsx)(`input`,{className:`form-input`,value:d?.telefone||``,onChange:e=>f({...d,telefone:e.target.value})})]})]}),(0,s.jsxs)(`div`,{className:`form-group`,children:[(0,s.jsx)(`label`,{className:`form-label`,children:`E-mail`}),(0,s.jsx)(`input`,{className:`form-input`,type:`email`,value:d?.email||``,onChange:e=>f({...d,email:e.target.value})})]})]}),(0,s.jsxs)(`div`,{className:`modal-footer`,children:[(0,s.jsx)(`button`,{type:`button`,className:`btn-secondary`,onClick:()=>u(!1),children:`Cancelar`}),(0,s.jsx)(`button`,{type:`submit`,className:`btn-primary`,children:`Salvar`})]})]})]})}),_&&(0,s.jsx)(`div`,{className:`modal-overlay`,children:(0,s.jsxs)(`div`,{className:`modal-content`,style:{maxWidth:`600px`},children:[(0,s.jsxs)(`div`,{className:`modal-header`,children:[(0,s.jsxs)(`h2`,{className:`modal-title`,children:[`Novo Pedido para `,p?.nome]}),(0,s.jsx)(`button`,{className:`modal-close`,onClick:()=>v(!1),children:`Ã—`})]}),(0,s.jsxs)(`div`,{className:`modal-body`,children:[(0,s.jsxs)(`div`,{className:`pedido-items-manager`,children:[(0,s.jsx)(`h3`,{children:`Itens do Pedido`}),(0,s.jsxs)(`div`,{className:`add-item-row`,style:{display:`grid`,gridTemplateColumns:`2fr 1fr 1fr auto`,gap:`0.5rem`,marginBottom:`1rem`},children:[(0,s.jsx)(`input`,{className:`form-input`,placeholder:`Produto`,id:`new-item-nome`}),(0,s.jsx)(`input`,{className:`form-input`,type:`number`,placeholder:`Qtd`,id:`new-item-qtd`}),(0,s.jsx)(`input`,{className:`form-input`,type:`number`,placeholder:`R$ Unit`,id:`new-item-preco`}),(0,s.jsx)(`button`,{className:`btn-primary`,onClick:()=>{let e=document.getElementById(`new-item-nome`).value,t=Number(document.getElementById(`new-item-qtd`).value),n=Number(document.getElementById(`new-item-preco`).value);e&&t>0&&(S([...x,{nome:e,quantidade:t,preco_unitario:n}]),document.getElementById(`new-item-nome`).value=``,document.getElementById(`new-item-qtd`).value=``,document.getElementById(`new-item-preco`).value=``)},children:`+`})]}),(0,s.jsx)(`ul`,{className:`pedido-list`,style:{listStyle:`none`,padding:0},children:x.map((e,t)=>(0,s.jsxs)(`li`,{style:{padding:`0.5rem`,borderBottom:`1px solid #eee`,display:`flex`,justifyContent:`space-between`},children:[(0,s.jsxs)(`span`,{children:[e.quantidade,`x `,e.nome,` - R$ `,((e.quantidade||0)*(e.preco_unitario||0)).toFixed(2)]}),(0,s.jsx)(`button`,{style:{color:`red`,border:`none`,background:`none`},onClick:()=>S(x.filter((e,n)=>n!==t)),children:`Remover`})]},t))})]}),(0,s.jsxs)(`div`,{className:`form-group`,style:{marginTop:`1rem`},children:[(0,s.jsx)(`label`,{className:`form-label`,children:`ObservaÃ§Ãµes`}),(0,s.jsx)(`textarea`,{className:`form-input`,value:y?.observacoes||``,onChange:e=>b({...y,observacoes:e.target.value})})]})]}),(0,s.jsxs)(`div`,{className:`modal-footer`,children:[(0,s.jsx)(`button`,{className:`btn-secondary`,onClick:()=>v(!1),children:`Cancelar`}),(0,s.jsx)(`button`,{className:`btn-primary`,onClick:E,children:`Enviar Pedido`})]})]})})]})}export{c as default};