import{c as e,n as t,o as n,r,t as i}from"./index-C9yBzEdM.js";import{t as a}from"./adminService-DRZDLqYL.js";var o=e(n(),1);const s={async listarFreelancers(e){let{data:n,error:r}=await t.from(`mkp_freelancers`).select(`*, perfil:perfis(*)`).eq(`empresa_id`,e);if(r)throw r;return n},async cadastrarFreelancer(e){let{data:n,error:r}=await t.from(`mkp_freelancers`).insert(e).select().single();if(r)throw r;return n},async listarVagas(e){let{data:n,error:r}=await t.from(`mkp_vagas`).select(`*, os:ordens_servico(*)`).eq(`empresa_id`,e).order(`created_at`,{ascending:!1});if(r)throw r;return n},async criarVaga(e){let{data:n,error:r}=await t.from(`mkp_vagas`).insert(e).select().single();if(r)throw r;return n},async candidatar(e,n){let{error:r}=await t.from(`mkp_participantes`).insert({vaga_id:e,freelancer_id:n});if(r)throw r},async avaliarServico(e){let{error:n}=await t.from(`mkp_avaliacoes`).insert(e);if(n)throw n;await this.prepararPagamento(e.os_id,e.freelancer_id,e.empresa_id)},async prepararPagamento(e,n,r){let{data:i}=await t.from(`mkp_participantes`).select(`valor_combinado`).eq(`freelancer_id`,n).eq(`status`,`selecionado`).single();i&&await t.from(`mkp_pagamentos`).insert({empresa_id:r,freelancer_id:n,os_id:e,valor:i.valor_combinado,status:`pendente`})},async listarPagamentos(e){let{data:n,error:r}=await t.from(`mkp_pagamentos`).select(`*, freelancer:mkp_freelancers(*, perfil:perfis(*))`).eq(`empresa_id`,e);if(r)throw r;return n},async atualizarStatusPagamento(e,n,r){let i={status:n};r&&(i.comprovante_url=r,i.data_pagamento=new Date().toISOString());let{error:a}=await t.from(`mkp_pagamentos`).update(i).eq(`id`,e);if(a)throw a}};var c=r();function l(){let{userProfile:e}=i(),[t,n]=(0,o.useState)([]),[r,l]=(0,o.useState)([]),[d,f]=(0,o.useState)([]),[p,m]=(0,o.useState)([]),[h,g]=(0,o.useState)(!0),[_,v]=(0,o.useState)(`network`),[y,b]=(0,o.useState)(!1),x=(0,o.useRef)(null);(0,o.useEffect)(()=>{if(x.current){let e=x.current.querySelector(`.tab-btn.active`);e&&e.scrollIntoView({behavior:`smooth`,inline:`center`,block:`nearest`})}},[_]);let S=e?.empresa_id||``,C=async()=>{if(S){g(!0);try{let[e,t,r,i]=await Promise.all([s.listarFreelancers(S),s.listarVagas(S),s.listarPagamentos(S),a.listarUsuariosPorEmpresa(S)]);n(e),l(t),f(r);let o=e.map(e=>e.perfil_id);m(i.filter(e=>!o.includes(e.id)))}catch(e){console.error(e)}finally{g(!1)}}};return(0,o.useEffect)(()=>{C()},[S]),h?(0,c.jsx)(`div`,{className:`marketplace-page`,children:(0,c.jsx)(`div`,{className:`loading-spinner`,children:`Conectando ao Marketplace...`})}):(0,c.jsxs)(`div`,{className:`marketplace-page`,children:[(0,c.jsxs)(`header`,{className:`page-header`,children:[(0,c.jsx)(`h1`,{className:`page-title`,children:`Marketplace de TÃ©cnicos`}),(0,c.jsx)(`p`,{className:`page-subtitle`,children:`Gerencie sua rede de tÃ©cnicos parceiros e freelancers.`})]}),(0,c.jsxs)(`div`,{className:`tabs-container horizontal-tabs-container hide-scrollbar`,ref:x,children:[(0,c.jsxs)(`button`,{onClick:()=>v(`network`),className:`tab-btn ${_===`network`?`active`:``}`,children:[`Rede de TÃ©cnicos (`,t.length,`)`]}),(0,c.jsxs)(`button`,{onClick:()=>v(`jobs`),className:`tab-btn ${_===`jobs`?`active`:``}`,children:[`Vagas em Aberto (`,r.filter(e=>e.status===`aberta`).length,`)`]}),(0,c.jsx)(`button`,{onClick:()=>v(`payments`),className:`tab-btn ${_===`payments`?`active`:``}`,children:`Pagamentos`})]}),_===`network`&&(0,c.jsxs)(`div`,{className:`network-section`,children:[(0,c.jsxs)(`div`,{className:`section-header`,style:{display:`flex`,justifyContent:`space-between`,alignItems:`center`},children:[(0,c.jsx)(`h3`,{children:`TÃ©cnicos Parceiros`}),(0,c.jsx)(`button`,{className:`btn-primary`,onClick:()=>b(!0),children:`+ Convidar TÃ©cnico`})]}),(0,c.jsx)(`div`,{className:`freelancer-grid`,children:t.length===0?(0,c.jsx)(`div`,{className:`empty-state`,children:`Nenhum tÃ©cnico autÃ´nomo cadastrado.`}):t.map(e=>(0,c.jsxs)(`div`,{className:`freelancer-card`,children:[(0,c.jsxs)(`div`,{className:`freelancer-header`,children:[(0,c.jsx)(`div`,{className:`freelancer-avatar`,children:e.perfil?.nome?.charAt(0)||`FT`}),(0,c.jsxs)(`div`,{className:`freelancer-info`,children:[(0,c.jsx)(`h4`,{children:e.perfil?.nome||`Freelancer`}),(0,c.jsxs)(`div`,{className:`freelancer-rating`,children:[(0,c.jsxs)(`span`,{children:[`â­ `,e.avaliacao_media.toFixed(1)]}),(0,c.jsxs)(`span`,{style:{fontSize:`0.75rem`,color:`#94a3b8`},children:[`(`,e.total_avaliacoes,` avaliaÃ§Ãµes)`]})]})]})]}),(0,c.jsx)(`div`,{className:`specialties-tags`,children:e.specialties.map(e=>(0,c.jsx)(`span`,{className:`tag`,children:e},e))}),(0,c.jsxs)(`div`,{style:{fontSize:`0.85rem`,color:`#64748b`},children:[`ðŸ“ `,e.regioes_atendimento.join(`, `)]}),(0,c.jsx)(`div`,{className:`card-actions`,style:{marginTop:`1rem`},children:(0,c.jsx)(`button`,{className:`btn-outline`,style:{width:`100%`,fontSize:`0.85rem`},children:`Ver Perfil Completo`})})]},e.id))})]}),_===`jobs`&&(0,c.jsxs)(`div`,{className:`jobs-section`,children:[(0,c.jsx)(`h3`,{children:`Oportunidades Publicadas`}),(0,c.jsx)(`div`,{className:`jobs-list`,children:r.length===0?(0,c.jsx)(`div`,{className:`empty-state`,children:`Nenhuma vaga publicada no momento.`}):r.map(e=>(0,c.jsxs)(`div`,{className:`job-card`,children:[(0,c.jsxs)(`div`,{className:`job-details`,children:[(0,c.jsx)(`h5`,{children:e.titulo}),(0,c.jsxs)(`div`,{className:`job-meta`,children:[(0,c.jsxs)(`span`,{children:[`ðŸ“… `,new Date(e.data_prevista).toLocaleDateString()]}),(0,c.jsxs)(`span`,{children:[`ðŸ› ï¸ `,e.os?.descricao?.substring(0,20)||`ManutenÃ§Ã£o`,`...`]}),(0,c.jsxs)(`span`,{children:[`ðŸ“‹ OS #`,e.os_id.substring(0,8)]})]})]}),(0,c.jsxs)(`div`,{style:{textAlign:`right`},children:[(0,c.jsxs)(`div`,{className:`job-value`,children:[`R$ `,e.valor_proposto.toFixed(2)]}),(0,c.jsx)(`span`,{style:{fontSize:`0.75rem`,color:`#94a3b8`},children:e.status.toUpperCase()})]})]},e.id))})]}),_===`payments`&&(0,c.jsxs)(`div`,{className:`payments-section`,children:[(0,c.jsx)(`h3`,{children:`Controle de Repasses`}),(0,c.jsxs)(`div`,{className:`leaderboard-table`,style:{width:`100%`,borderCollapse:`collapse`,marginTop:`1.5rem`},children:[(0,c.jsxs)(`div`,{className:`leaderboard-row header`,style:{gridTemplateColumns:`1fr 1fr 120px 150px`},children:[(0,c.jsx)(`div`,{children:`TÃ©cnico`}),(0,c.jsx)(`div`,{children:`ServiÃ§o / OS`}),(0,c.jsx)(`div`,{children:`Valor`}),(0,c.jsx)(`div`,{children:`Status`})]}),d.length===0?(0,c.jsx)(`div`,{className:`empty-state`,children:`Nenhum pagamento registrado.`}):d.map(e=>(0,c.jsxs)(`div`,{className:`leaderboard-row`,style:{gridTemplateColumns:`1fr 1fr 120px 150px`},children:[(0,c.jsx)(`div`,{children:e.freelancer?.perfil?.nome}),(0,c.jsxs)(`div`,{children:[`OS #`,e.os_id.substring(0,8)]}),(0,c.jsxs)(`div`,{style:{fontWeight:700},children:[`R$ `,e.valor.toFixed(2)]}),(0,c.jsx)(`div`,{children:(0,c.jsx)(`span`,{className:`payment-badge ${e.status}`,children:e.status})})]},e.id))]})]}),y&&(0,c.jsx)(u,{usuarios:p,empresaId:S,onClose:()=>b(!1),onSuccess:()=>{b(!1),C()}})]})}function u({usuarios:e,empresaId:t,onClose:n,onSuccess:r}){let[i,a]=(0,o.useState)({perfil_id:``,specialties:``,regioes_atendimento:``}),[l,u]=(0,o.useState)(!1);return(0,c.jsx)(`div`,{className:`modal-overlay`,style:{position:`fixed`,top:0,left:0,right:0,bottom:0,background:`rgba(0,0,0,0.5)`,display:`flex`,alignItems:`center`,justifyContent:`center`,zIndex:1e3},children:(0,c.jsxs)(`div`,{className:`modal-content`,style:{background:`white`,padding:`2rem`,borderRadius:`24px`,width:`100%`,maxWidth:`500px`},children:[(0,c.jsx)(`h3`,{children:`Convidar TÃ©cnico para Rede`}),(0,c.jsxs)(`form`,{onSubmit:async e=>{e.preventDefault(),u(!0);try{await s.cadastrarFreelancer({perfil_id:i.perfil_id,empresa_id:t,specialties:i.specialties.split(`,`).map(e=>e.trim()),regioes_atendimento:i.regioes_atendimento.split(`,`).map(e=>e.trim()),status:`ativo`,avaliacao_media:5,total_avaliacoes:0}),r()}catch(e){alert(`Erro ao convidar tÃ©cnico`),console.error(e)}finally{u(!1)}},style:{display:`flex`,flexDirection:`column`,gap:`1rem`,marginTop:`1rem`},children:[(0,c.jsxs)(`div`,{className:`form-group`,style:{display:`flex`,flexDirection:`column`,gap:`0.25rem`},children:[(0,c.jsx)(`label`,{children:`Selecionar UsuÃ¡rio da Empresa`}),(0,c.jsxs)(`select`,{required:!0,className:`form-control`,value:i.perfil_id,onChange:e=>a({...i,perfil_id:e.target.value}),children:[(0,c.jsx)(`option`,{value:``,children:`Selecione um usuÃ¡rio`}),e.map(e=>(0,c.jsxs)(`option`,{value:e.id,children:[e.nome,` (`,e.role,`)`]},e.id))]})]}),(0,c.jsxs)(`div`,{className:`form-group`,style:{display:`flex`,flexDirection:`column`,gap:`0.25rem`},children:[(0,c.jsx)(`label`,{children:`Especialidades (separadas por vÃ­rgula)`}),(0,c.jsx)(`input`,{required:!0,placeholder:`Ex: Split, Chiller, VRF`,className:`form-control`,value:i.specialties,onChange:e=>a({...i,specialties:e.target.value})})]}),(0,c.jsxs)(`div`,{className:`form-group`,style:{display:`flex`,flexDirection:`column`,gap:`0.25rem`},children:[(0,c.jsx)(`label`,{children:`RegiÃµes de Atendimento`}),(0,c.jsx)(`input`,{required:!0,placeholder:`Ex: Centro, Zona Sul, Grande SP`,className:`form-control`,value:i.regioes_atendimento,onChange:e=>a({...i,regioes_atendimento:e.target.value})})]}),(0,c.jsxs)(`div`,{className:`modal-actions`,style:{display:`flex`,gap:`1rem`,marginTop:`1.5rem`},children:[(0,c.jsx)(`button`,{type:`button`,className:`btn-outline`,onClick:n,style:{flex:1},children:`Cancelar`}),(0,c.jsx)(`button`,{type:`submit`,className:`btn-primary`,disabled:l,style:{flex:1},children:l?`Processando...`:`Confirmar Convite`})]})]})]})})}export{l as MarketplacePage,l as default};