import{c as e,n as t,o as n,r,t as i}from"./index-C9yBzEdM.js";/* empty css                 */import{t as a}from"./clientesService-BnZzC_Tg.js";import{t as o}from"./estoqueService-7b9QeiRZ.js";/* empty css               */var s=e(n(),1);const c={async listar(){let{data:e,error:n}=await t.from(`orcamentos`).select(`
                *,
                cliente:clientes(id, nome, telefone, email)
            `).order(`created_at`,{ascending:!1});if(n)throw n;return e||[]},async buscarPorId(e){let{data:n,error:r}=await t.from(`orcamentos`).select(`
                *,
                cliente:clientes(*)
            `).eq(`id`,e).single();if(r)throw r;return n},async criar(e){let{data:{user:n}}=await t.auth.getUser();if(!n)throw Error(`Usuário não autenticado`);let{data:r}=await t.from(`perfis`).select(`empresa_id`).eq(`id`,n.id).single();if(!r?.empresa_id)throw Error(`Empresa não encontrada para o usuário`);let{data:i,error:a}=await t.from(`orcamentos`).insert([{...e,empresa_id:r.empresa_id}]).select().single();if(a)throw a;return i},async atualizar(e,n){let{data:r,error:i}=await t.from(`orcamentos`).update(n).eq(`id`,e).select().single();if(i)throw i;return r},async excluir(e){let{error:n}=await t.from(`orcamentos`).delete().eq(`id`,e);if(n)throw n},async listarItens(e){let{data:n,error:r}=await t.from(`itens_orcamento`).select(`*`).eq(`orcamento_id`,e).order(`created_at`,{ascending:!0});if(r)throw r;return n||[]},async adicionarItem(e){let{data:{user:n}}=await t.auth.getUser(),{data:r}=await t.from(`perfis`).select(`empresa_id`).eq(`id`,n?.id).single(),{data:i,error:a}=await t.from(`itens_orcamento`).insert([{...e,empresa_id:r?.empresa_id}]).select().single();if(a)throw a;return i},async removerItem(e){let{error:n}=await t.from(`itens_orcamento`).delete().eq(`id`,e);if(n)throw n}};var l=r(),u=()=>(0,l.jsxs)(`svg`,{width:`16`,height:`16`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,l.jsx)(`path`,{d:`M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7`}),(0,l.jsx)(`path`,{d:`M18.5 2.5a2.121 2 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z`})]}),d=()=>(0,l.jsxs)(`svg`,{width:`20`,height:`20`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,l.jsx)(`line`,{x1:`18`,y1:`6`,x2:`6`,y2:`18`}),(0,l.jsx)(`line`,{x1:`6`,y1:`6`,x2:`18`,y2:`18`})]}),f=()=>(0,l.jsxs)(`svg`,{width:`48`,height:`48`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`1.5`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,l.jsx)(`line`,{x1:`12`,y1:`1`,x2:`12`,y2:`23`}),(0,l.jsx)(`path`,{d:`M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6`})]});function p({orcamento:e,clientes:t,onClose:n,onSave:r}){let[i,a]=(0,s.useState)({cliente_id:e?.cliente_id||``,valor:e?.valor||0,descricao:e?.descricao||``,equipamento:e?.equipamento||``,data_inicio:e?.data_inicio||``,data_fim:e?.data_fim||``,status:e?.status||`pendente`,observacoes:e?.observacoes||``}),[u,f]=(0,s.useState)([]),[p,m]=(0,s.useState)([]),[h,g]=(0,s.useState)(!1),[_,v]=(0,s.useState)(!1),[y,b]=(0,s.useState)(``);(0,s.useEffect)(()=>{(async()=>{v(!0);try{let[t,n]=await Promise.all([o.listar(),e?c.listarItens(e.id):Promise.resolve([])]);m(t),f(n)}catch(e){console.error(`Erro ao carregar dados do modal:`,e)}finally{v(!1)}})()},[e]),(0,s.useEffect)(()=>{let e=u.reduce((e,t)=>e+Number(t.preco_unitario)*Number(t.quantidade),0);e>0&&a(t=>({...t,valor:e}))},[u]);let x=async t=>{try{let n={orcamento_id:e?.id||`temp`,item_id:t.id,nome:t.nome,quantidade:1,preco_unitario:t.preco_venda||t.preco_unitario};if(e){let e=await c.adicionarItem(n);f([...u,e])}else f([...u,{...n,id:Math.random().toString(),total:n.quantidade*n.preco_unitario}])}catch(e){console.error(`Erro ao adicionar item:`,e)}},S=async t=>{try{e&&!t.startsWith(`0.`)&&await c.removerItem(t),f(u.filter(e=>e.id!==t))}catch(e){console.error(`Erro ao remover item:`,e)}},C=async t=>{if(t.preventDefault(),!i.cliente_id){b(`Selecione um cliente`);return}g(!0),b(``);try{let t;e?t=await c.atualizar(e.id,i):(t=await c.criar(i),u.length>0&&await Promise.all(u.map(e=>c.adicionarItem({orcamento_id:t.id,item_id:e.item_id,nome:e.nome,quantidade:e.quantidade,preco_unitario:e.preco_unitario})))),r()}catch(e){console.error(`Erro ao salvar orçamento:`,e),b(`Erro ao salvar orçamento. Tente novamente.`)}finally{g(!1)}},w=t.find(e=>e.id===i.cliente_id)||e?.cliente;return(0,l.jsx)(`div`,{className:`modal-overlay`,onClick:n,children:(0,l.jsxs)(`div`,{className:`modal-content`,style:{maxWidth:`600px`},onClick:e=>e.stopPropagation(),children:[(0,l.jsxs)(`div`,{className:`modal-header`,children:[(0,l.jsx)(`h2`,{className:`modal-title`,children:e?`Editar Orçamento`:`Novo Orçamento`}),(0,l.jsx)(`button`,{className:`modal-close`,onClick:n,children:(0,l.jsx)(d,{})})]}),(0,l.jsxs)(`form`,{onSubmit:C,children:[(0,l.jsxs)(`div`,{className:`modal-body`,children:[y&&(0,l.jsx)(`div`,{className:`error-message`,style:{marginBottom:`1rem`},children:y}),(0,l.jsxs)(`div`,{className:`form-group`,children:[(0,l.jsx)(`label`,{className:`form-label`,children:`Cliente *`}),(0,l.jsxs)(`select`,{className:`form-input`,value:i.cliente_id,onChange:e=>a({...i,cliente_id:e.target.value}),disabled:h||!!e,required:!0,children:[(0,l.jsx)(`option`,{value:``,children:`Selecione um cliente`}),t.map(e=>(0,l.jsx)(`option`,{value:e.id,children:e.nome},e.id))]})]}),(0,l.jsxs)(`div`,{className:`form-group`,children:[(0,l.jsx)(`label`,{className:`form-label`,children:`Equipamento`}),(0,l.jsx)(`input`,{type:`text`,className:`form-input`,value:i.equipamento,onChange:e=>a({...i,equipamento:e.target.value}),placeholder:`Ex: Split 12000 BTUs LG`,disabled:h})]}),(0,l.jsxs)(`div`,{className:`form-group`,children:[(0,l.jsx)(`label`,{className:`form-label`,children:`O que vai fazer (Serviço)`}),(0,l.jsx)(`textarea`,{className:`form-input`,value:i.descricao,onChange:e=>a({...i,descricao:e.target.value}),placeholder:`Descrição do serviço...`,disabled:h,rows:3,required:!0})]}),(0,l.jsxs)(`div`,{className:`form-row`,style:{display:`grid`,gridTemplateColumns:`1fr 1fr`,gap:`1rem`},children:[(0,l.jsxs)(`div`,{className:`form-group`,children:[(0,l.jsx)(`label`,{className:`form-label`,children:`Data Início`}),(0,l.jsx)(`input`,{type:`date`,className:`form-input`,value:i.data_inicio,onChange:e=>a({...i,data_inicio:e.target.value}),disabled:h})]}),(0,l.jsxs)(`div`,{className:`form-group`,children:[(0,l.jsx)(`label`,{className:`form-label`,children:`Data Fim`}),(0,l.jsx)(`input`,{type:`date`,className:`form-input`,value:i.data_fim,onChange:e=>a({...i,data_fim:e.target.value}),disabled:h})]})]}),(0,l.jsxs)(`div`,{className:`form-group`,children:[(0,l.jsx)(`label`,{className:`form-label`,children:`Peças e Materiais (Estoque)`}),_?(0,l.jsx)(`div`,{style:{fontSize:`0.9rem`,color:`#64748b`},children:`Carregando catálogo...`}):(0,l.jsx)(`div`,{className:`inventory-selector`,style:{display:`flex`,gap:`0.5rem`,marginBottom:`1rem`},children:(0,l.jsxs)(`select`,{className:`form-input`,onChange:e=>{let t=p.find(t=>t.id===e.target.value);t&&x(t),e.target.value=``},defaultValue:``,children:[(0,l.jsx)(`option`,{value:``,disabled:!0,children:`+ Adicionar peça do estoque`}),p.map(e=>(0,l.jsxs)(`option`,{value:e.id,children:[e.nome,` (Saldo: `,e.quantidade,` `,e.unidade,` | R$ `,e.preco_venda?.toFixed(2),`)`]},e.id))]})}),u.length>0&&(0,l.jsx)(`div`,{className:`budget-items-list`,style:{background:`#f8fafc`,padding:`1rem`,borderRadius:`8px`,marginBottom:`1rem`},children:u.map(e=>(0,l.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`,alignItems:`center`,marginBottom:`0.5rem`,paddingBottom:`0.5rem`,borderBottom:`1px solid #e2e8f0`},children:[(0,l.jsxs)(`div`,{style:{flex:1},children:[(0,l.jsx)(`div`,{style:{fontWeight:600},children:e.nome}),(0,l.jsxs)(`div`,{style:{fontSize:`0.85rem`,color:`#64748b`},children:[e.quantidade,` x R$ `,Number(e.preco_unitario).toFixed(2)]})]}),(0,l.jsxs)(`div`,{style:{fontWeight:600,marginRight:`1rem`},children:[`R$ `,Number(e.total||e.quantidade*e.preco_unitario).toFixed(2)]}),(0,l.jsx)(`button`,{type:`button`,onClick:()=>S(e.id),style:{color:`#ef4444`,background:`none`,border:`none`,cursor:`pointer`,padding:`4px`},children:`×`})]},e.id))})]}),(0,l.jsxs)(`div`,{className:`form-row`,style:{display:`grid`,gridTemplateColumns:`minmax(200px, 1fr) 1fr`,gap:`1rem`},children:[(0,l.jsxs)(`div`,{className:`form-group`,children:[(0,l.jsx)(`label`,{className:`form-label`,children:`Preço Total (R$)`}),(0,l.jsx)(`input`,{type:`number`,step:`0.01`,className:`form-input`,value:i.valor||``,onChange:e=>a({...i,valor:parseFloat(e.target.value)||0}),placeholder:`0,00`,disabled:h,required:!0})]}),(0,l.jsxs)(`div`,{className:`form-group`,children:[(0,l.jsx)(`label`,{className:`form-label`,children:`Status`}),(0,l.jsxs)(`select`,{className:`form-input`,value:i.status,onChange:e=>a({...i,status:e.target.value}),disabled:h,children:[(0,l.jsx)(`option`,{value:`pendente`,children:`Pendente`}),(0,l.jsx)(`option`,{value:`aprovado`,children:`Aprovado`}),(0,l.jsx)(`option`,{value:`rejeitado`,children:`Rejeitado`}),(0,l.jsx)(`option`,{value:`concluido`,children:`Concluido`})]})]})]}),(0,l.jsx)(`p`,{style:{fontSize:`0.8rem`,color:`#64748b`,marginTop:`-0.5rem`,marginBottom:`1rem`},children:u.length>0?`✓ Valor calculado auto. pelas peças.`:`Informe o valor total do serviço.`}),(0,l.jsxs)(`div`,{className:`form-group`,children:[(0,l.jsx)(`label`,{className:`form-label`,children:`Observações Detalhadas`}),(0,l.jsx)(`textarea`,{className:`form-input`,value:i.observacoes,onChange:e=>a({...i,observacoes:e.target.value}),placeholder:`Informações adicionais para o cliente...`,disabled:h,rows:3})]}),(0,l.jsx)(`div`,{className:`share-buttons`,style:{display:`flex`,gap:`0.5rem`,marginTop:`1rem`},children:(0,l.jsx)(`button`,{type:`button`,className:`btn-secondary`,style:{flex:1,display:`flex`,alignItems:`center`,justifyContent:`center`,gap:`0.5rem`,background:`#25D366`,color:`white`,border:`none`},onClick:()=>{let e=`Olá ${w?.nome||``}, segue o orçamento:\n\n*Serviço:* ${i.descricao||`N/A`}\n*Equipamento:* ${i.equipamento||`N/A`}\n*Data Início:* ${i.data_inicio||`-`}\n*Data Fim:* ${i.data_fim||`-`}\n*Valor:* R$ ${i.valor?.toFixed(2)||`0.00`}\n*Observações:* ${i.observacoes||`-`}\n\nFicamos no aguardo da aprovação!`;window.open(`https://wa.me/${w?.telefone?.replace(/\D/g,``)}?text=${encodeURIComponent(e)}`,`_blank`)},children:`WhatsApp`})})]}),(0,l.jsxs)(`div`,{className:`modal-footer`,children:[(0,l.jsx)(`button`,{type:`button`,className:`btn-secondary`,onClick:n,disabled:h,children:`Cancelar`}),(0,l.jsx)(`button`,{type:`submit`,className:`btn-primary`,disabled:h,children:h?`Salvando...`:`Salvar Orçamento`})]})]})]})})}function m(){let{userProfile:e}=i(),[t,n]=(0,s.useState)([]),[r,o]=(0,s.useState)([]),[d,m]=(0,s.useState)(!0),[h,g]=(0,s.useState)(null),[_,v]=(0,s.useState)(!1),y=async()=>{try{m(!0);let[e,t]=await Promise.all([c.listar(),a.listar()]);n(e),o(t)}catch(e){console.error(`Erro ao carregar orçamentos:`,e)}finally{m(!1)}};return(0,s.useEffect)(()=>{y()},[]),e?.role===`tecnico`?(0,l.jsx)(`div`,{className:`p-8`,children:`Acesso restrito a administradores.`}):(0,l.jsxs)(`div`,{className:`ordens-page`,children:[(0,l.jsxs)(`div`,{className:`page-header`,children:[(0,l.jsx)(`h1`,{className:`page-title`,children:`Gestão de Orçamentos`}),(0,l.jsx)(`button`,{className:`btn-primary`,onClick:()=>v(!0),children:`Novo Orçamento`})]}),d?(0,l.jsx)(`div`,{className:`table-container`,children:(0,l.jsx)(`div`,{className:`loading-spinner`,children:(0,l.jsx)(`div`,{className:`spinner`})})}):t.length===0?(0,l.jsx)(`div`,{className:`table-container`,children:(0,l.jsxs)(`div`,{className:`empty-state`,children:[(0,l.jsx)(`div`,{className:`empty-icon`,children:(0,l.jsx)(f,{})}),(0,l.jsx)(`h3`,{className:`empty-title`,children:`Nenhum orçamento cadastrado`}),(0,l.jsx)(`button`,{className:`btn-primary`,style:{marginTop:`1rem`},onClick:()=>v(!0),children:`Criar Primeiro Orçamento`})]})}):(0,l.jsx)(`div`,{className:`table-container`,children:(0,l.jsxs)(`table`,{className:`data-table`,children:[(0,l.jsx)(`thead`,{children:(0,l.jsxs)(`tr`,{children:[(0,l.jsx)(`th`,{children:`Cliente`}),(0,l.jsx)(`th`,{children:`Equipamento`}),(0,l.jsx)(`th`,{children:`Serviço`}),(0,l.jsx)(`th`,{children:`Valor`}),(0,l.jsx)(`th`,{children:`Início/Fim`}),(0,l.jsx)(`th`,{children:`Status`}),(0,l.jsx)(`th`,{children:`Ações`})]})}),(0,l.jsx)(`tbody`,{children:t.map(e=>(0,l.jsxs)(`tr`,{children:[(0,l.jsx)(`td`,{children:e.cliente?.nome||`N/A`}),(0,l.jsx)(`td`,{children:e.equipamento}),(0,l.jsx)(`td`,{style:{maxWidth:`200px`,overflow:`hidden`,textOverflow:`ellipsis`,whiteSpace:`nowrap`},children:e.descricao}),(0,l.jsxs)(`td`,{style:{fontWeight:600,color:`#059669`},children:[`R$ `,e.valor?.toFixed(2)]}),(0,l.jsx)(`td`,{children:(0,l.jsxs)(`div`,{style:{fontSize:`0.85rem`},children:[e.data_inicio||`-`,` `,(0,l.jsx)(`br`,{}),e.data_fim||`-`]})}),(0,l.jsx)(`td`,{children:(0,l.jsx)(`span`,{className:`status-badge ${e.status}`,children:e.status})}),(0,l.jsx)(`td`,{children:(0,l.jsx)(`button`,{className:`btn-icon`,onClick:()=>g(e),title:`Editar Orçamento`,children:(0,l.jsx)(u,{})})})]},e.id))})]})}),(h||_)&&(0,l.jsx)(p,{orcamento:h,clientes:r,onClose:()=>{g(null),v(!1)},onSave:()=>{g(null),v(!1),y()}})]})}export{m as OrcamentosPage,m as default};