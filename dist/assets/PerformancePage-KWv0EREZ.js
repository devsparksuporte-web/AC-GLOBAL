import{c as e,n as t,o as n,r,t as i}from"./index-C9yBzEdM.js";import{t as a}from"./weatherService-CZMQaj8j.js";var o=e(n(),1);const s={async getDemandForecast(){let{data:{user:e}}=await t.auth.getUser();if(!e)throw Error(`Não autenticado`);let{data:n}=await t.from(`perfis`).select(`empresa_id`).eq(`id`,e.id).single(),r=new Date,i=new Date(r.getFullYear()-1,r.getMonth(),1),{data:a,error:o}=await t.from(`ordens_servico`).select(`created_at`).eq(`empresa_id`,n?.empresa_id).gte(`created_at`,i.toISOString());if(o)throw o;let s=[`Jan`,`Fev`,`Mar`,`Abr`,`Mai`,`Jun`,`Jul`,`Ago`,`Set`,`Out`,`Nov`,`Dez`],c={};for(let e=0;e<12;e++){let t=new Date(r.getFullYear(),r.getMonth()-e,1),n=`${s[t.getMonth()]}/${t.getFullYear().toString().substr(2)}`;c[n]={historico:0,previsto:0}}a?.forEach(e=>{let t=new Date(e.created_at),n=`${s[t.getMonth()]}/${t.getFullYear().toString().substr(2)}`;c[n]&&c[n].historico++});let l=Object.entries(c).map(([e,t])=>({mes:e,...t})).reverse(),u=(l[9].historico+l[10].historico+l[11].historico)/3,d=e=>[10,11,0,1,2].includes(e)?1.4:.9,f=[];for(let e=1;e<=3;e++){let t=new Date(r.getFullYear(),r.getMonth()+e,1),n=`${s[t.getMonth()]}/${t.getFullYear().toString().substr(2)}`,i=d(t.getMonth());f.push({mes:n,historico:0,previsto:Math.round(u*i)})}return[...l,...f]},async getTeamOptimization(){let{data:{user:e}}=await t.auth.getUser();if(!e)throw Error(`Não autenticado`);let{data:n}=await t.from(`perfis`).select(`empresa_id`).eq(`id`,e.id).single(),{count:r}=await t.from(`perfis`).select(`*`,{count:`exact`,head:!0}).eq(`empresa_id`,n?.empresa_id).eq(`role`,`tecnico`),i=(r||1)*66,a=new Date;a.setMonth(a.getMonth()-2);let{count:o}=await t.from(`ordens_servico`).select(`*`,{count:`exact`,head:!0}).eq(`empresa_id`,n?.empresa_id).gte(`created_at`,a.toISOString()),s=(o||1)/2,c=s/i,l=`manter`,u=`Equipe dimensionada corretamente para a demanda atual.`;return c>.95?(l=`contratar_urgente`,u=`Sua equipe está operando no limite (95%+). Risco de atrasos e perda de qualidade.`):c>.8&&(l=`contratar_leve`,u=`Demanda em crescimento. Considere contratar 1 novo técnico nos próximos 30 dias.`),{tecnicosAtuais:r||0,capacidadeMensal:i,demandaProjetada:Math.round(s*1.1),recomendacao:l,mensagem:u}},async getStockPrediction(){let{data:{user:e}}=await t.auth.getUser();if(!e)throw Error(`Não autenticado`);let{data:n}=await t.from(`perfis`).select(`empresa_id`).eq(`id`,e.id).single(),{data:r}=await t.from(`estoque`).select(`*`).eq(`empresa_id`,n?.empresa_id);if(!r)return[];let i=new Date;i.setDate(i.getDate()-60);let{data:a}=await t.from(`movimentacao_estoque`).select(`*`).eq(`empresa_id`,n?.empresa_id).eq(`tipo`,`saida`).gte(`created_at`,i.toISOString());return r.map(e=>{let t=(a?.filter(t=>t.item_id===e.id).reduce((e,t)=>e+t.quantidade,0)||0)/60,n=t>0?Math.floor(e.quantidade/t):999;return{item_id:e.id,nome:e.nome,quantidade_atual:e.quantidade,consumo_diario:parseFloat(t.toFixed(2)),dias_restantes:n,nivel_critico:n<15}}).filter(e=>e.consumo_diario>0||e.quantidade_atual<5).sort((e,t)=>e.dias_restantes-t.dias_restantes)}};var c=r(),l=()=>(0,c.jsxs)(`svg`,{width:`24`,height:`24`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,c.jsx)(`polyline`,{points:`23 6 13.5 15.5 8.5 10.5 1 18`}),(0,c.jsx)(`polyline`,{points:`17 6 23 6 23 12`})]}),u=()=>(0,c.jsxs)(`svg`,{width:`24`,height:`24`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,c.jsx)(`path`,{d:`M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2`}),(0,c.jsx)(`circle`,{cx:`8.5`,cy:`7`,r:`4`}),(0,c.jsx)(`line`,{x1:`20`,y1:`8`,x2:`20`,y2:`14`}),(0,c.jsx)(`line`,{x1:`17`,y1:`11`,x2:`23`,y2:`11`})]}),d=()=>(0,c.jsxs)(`svg`,{width:`24`,height:`24`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,c.jsx)(`path`,{d:`M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z`}),(0,c.jsx)(`line`,{x1:`12`,y1:`9`,x2:`12`,y2:`13`}),(0,c.jsx)(`line`,{x1:`12`,y1:`17`,x2:`12.01`,y2:`17`})]}),f=()=>(0,c.jsxs)(`svg`,{width:`24`,height:`24`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,c.jsx)(`path`,{d:`M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z`}),(0,c.jsx)(`polyline`,{points:`3.27 6.96 12 12.01 20.73 6.96`}),(0,c.jsx)(`line`,{x1:`12`,y1:`22.08`,x2:`12`,y2:`12`})]}),p=()=>(0,c.jsxs)(`svg`,{width:`24`,height:`24`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,children:[(0,c.jsx)(`path`,{d:`M16 13a4 4 0 0 1-8 0 4 4 0 0 1 0-8c2.1 0 3.1 1 4 2 1.1 0 2.1 1 3 2.1a4 4 0 0 1 1 3.9z`}),(0,c.jsx)(`path`,{d:`M12 15v3`}),(0,c.jsx)(`path`,{d:`M8 17v2`}),(0,c.jsx)(`path`,{d:`M16 17v2`})]});function m(){let{userProfile:e}=i(),[t,n]=(0,o.useState)(!0),[r,m]=(0,o.useState)([]),[h,g]=(0,o.useState)(null),[_,v]=(0,o.useState)([]),[y,b]=(0,o.useState)(null),[x,S]=(0,o.useState)([]);(0,o.useEffect)(()=>{(async()=>{try{n(!0);let t=e?.latitude||-23.5505,r=e?.longitude||-46.6333,[i,o,c,l]=await Promise.all([s.getDemandForecast(),s.getTeamOptimization(),s.getStockPrediction(),a.getWeather(t,r)]);m(i),g(o),v(c),b(l),S(a.getAlerts(l))}catch(e){console.error(`Erro ao carregar dados de performance:`,e)}finally{n(!1)}})()},[e?.latitude,e?.longitude]);let C=Math.max(...r.map(e=>Math.max(e.historico,e.previsto)),1);return t?(0,c.jsx)(`div`,{className:`table-container`,children:(0,c.jsx)(`div`,{className:`loading-spinner`,children:(0,c.jsx)(`div`,{className:`spinner`})})}):(0,c.jsxs)(`div`,{className:`performance-page`,children:[(0,c.jsx)(`div`,{className:`performance-header`,children:(0,c.jsx)(`h1`,{className:`page-title`,children:`Análise de Performance & Projeções`})}),(0,c.jsxs)(`div`,{className:`insights-grid`,children:[h&&(0,c.jsxs)(`div`,{className:`insight-card ${h.recomendacao}`,children:[(0,c.jsxs)(`div`,{className:`insight-header`,children:[(0,c.jsx)(`div`,{className:`insight-icon`,style:{background:`rgba(99, 102, 241, 0.1)`,color:`#6366f1`},children:(0,c.jsx)(u,{})}),(0,c.jsx)(`span`,{className:`insight-title`,children:`Capacidade da Equipe`})]}),(0,c.jsxs)(`div`,{className:`insight-value`,children:[h.tecnicosAtuais,(0,c.jsx)(`span`,{className:`insight-unit`,children:`Técnicos Ativos`})]}),(0,c.jsx)(`p`,{className:`insight-message`,children:h.mensagem})]}),(0,c.jsxs)(`div`,{className:`insight-card critico`,children:[(0,c.jsxs)(`div`,{className:`insight-header`,children:[(0,c.jsx)(`div`,{className:`insight-icon`,style:{background:`rgba(239, 68, 68, 0.1)`,color:`#ef4444`},children:(0,c.jsx)(d,{})}),(0,c.jsx)(`span`,{className:`insight-title`,children:`Peças em Risco`})]}),(0,c.jsxs)(`div`,{className:`insight-value`,children:[_.filter(e=>e.nivel_critico).length,(0,c.jsx)(`span`,{className:`insight-unit`,children:`Itens para Reposição`})]}),(0,c.jsx)(`p`,{className:`insight-message`,children:`Baseado no ritmo de consumo dos últimos 60 dias.`})]}),y&&(0,c.jsxs)(`div`,{className:`insight-card weather-card`,children:[(0,c.jsxs)(`div`,{className:`insight-header`,children:[(0,c.jsx)(`div`,{className:`insight-icon`,style:{background:`rgba(59, 130, 246, 0.1)`,color:`#3b82f6`},children:(0,c.jsx)(p,{})}),(0,c.jsx)(`span`,{className:`insight-title`,children:`Clima Local`})]}),(0,c.jsxs)(`div`,{className:`insight-value`,children:[y.temperature,`°C`,(0,c.jsx)(`span`,{className:`insight-unit`,children:y.condition})]}),(0,c.jsx)(`div`,{className:`weather-forecast-mini`,children:y.forecast.slice(1,4).map((e,t)=>(0,c.jsxs)(`div`,{className:`forecast-day`,children:[(0,c.jsx)(`span`,{children:new Date(e.date).toLocaleDateString(`pt-BR`,{weekday:`short`})}),(0,c.jsxs)(`strong`,{children:[e.maxTemp,`°`]})]},t))})]})]}),x.length>0&&(0,c.jsx)(`div`,{className:`climate-alerts-section`,children:x.map((e,t)=>(0,c.jsxs)(`div`,{className:`climate-alert ${e.severity}`,children:[(0,c.jsxs)(`div`,{className:`alert-header`,children:[(0,c.jsx)(d,{}),(0,c.jsx)(`strong`,{children:e.type===`heatwave`?`Onda de Calor`:`Alerta Meteorológico`})]}),(0,c.jsxs)(`div`,{className:`alert-content`,children:[(0,c.jsx)(`p`,{children:e.description}),(0,c.jsxs)(`div`,{className:`alert-suggestion`,children:[(0,c.jsx)(`strong`,{children:`Ação Proativa:`}),` `,e.suggestion]})]})]},t))}),(0,c.jsxs)(`div`,{className:`forecast-section`,children:[(0,c.jsxs)(`div`,{className:`section-header`,children:[(0,c.jsxs)(`div`,{className:`insight-header`,children:[(0,c.jsx)(l,{}),(0,c.jsx)(`h3`,{className:`insight-title`,children:`Previsão de Demanda Mensal`})]}),(0,c.jsxs)(`div`,{className:`chart-legend`,children:[(0,c.jsxs)(`div`,{className:`legend-item`,children:[(0,c.jsx)(`div`,{className:`legend-color`,style:{background:`var(--color-primary)`}}),(0,c.jsx)(`span`,{children:`Histórico`})]}),(0,c.jsxs)(`div`,{className:`legend-item`,children:[(0,c.jsx)(`div`,{className:`legend-color previsto`}),(0,c.jsx)(`span`,{children:`Previsão`})]})]})]}),(0,c.jsx)(`div`,{className:`chart-container horizontal-scroll hide-scrollbar`,children:r.map((e,t)=>(0,c.jsxs)(`div`,{className:`chart-bar-group`,children:[e.historico>0&&(0,c.jsx)(`div`,{className:`chart-bar historico`,style:{height:`${e.historico/C*80}%`},children:(0,c.jsxs)(`div`,{className:`chart-bar-tooltip`,children:[e.historico,` OS`]})}),e.previsto>0&&(0,c.jsx)(`div`,{className:`chart-bar previsto`,style:{height:`${e.previsto/C*80}%`},children:(0,c.jsxs)(`div`,{className:`chart-bar-tooltip`,children:[e.previsto,` OS (Projeção)`]})}),(0,c.jsx)(`span`,{className:`chart-label`,children:e.mes})]},t))})]}),(0,c.jsxs)(`div`,{className:`stock-table-card`,children:[(0,c.jsxs)(`div`,{className:`card-title-container`,children:[(0,c.jsx)(f,{}),(0,c.jsx)(`h3`,{className:`insight-title`,children:`Projeção de Ruptura de Estoque`})]}),(0,c.jsx)(`div`,{className:`table-container`,style:{margin:0,boxShadow:`none`},children:(0,c.jsxs)(`table`,{className:`stock-table`,children:[(0,c.jsx)(`thead`,{children:(0,c.jsxs)(`tr`,{children:[(0,c.jsx)(`th`,{children:`Item`}),(0,c.jsx)(`th`,{children:`Qtd Atual`}),(0,c.jsx)(`th`,{children:`Consumo Médio`}),(0,c.jsx)(`th`,{children:`Expectativa`})]})}),(0,c.jsx)(`tbody`,{children:_.length===0?(0,c.jsx)(`tr`,{children:(0,c.jsx)(`td`,{colSpan:4,style:{textAlign:`center`,padding:`2rem`},children:`Padrões de consumo não detectados ainda.`})}):_.map(e=>(0,c.jsxs)(`tr`,{children:[(0,c.jsx)(`td`,{style:{fontWeight:600},children:e.nome}),(0,c.jsx)(`td`,{children:e.quantidade_atual}),(0,c.jsxs)(`td`,{children:[e.consumo_diario,` /dia`]}),(0,c.jsx)(`td`,{children:(0,c.jsx)(`span`,{className:`stock-badge ${e.dias_restantes<15?`critico`:`alerta`}`,children:e.dias_restantes>100?`+3 meses`:`${e.dias_restantes} dias`})})]},e.item_id))})]})})]})]})}export{m as PerformancePage,m as default};