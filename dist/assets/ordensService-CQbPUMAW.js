import{n as e}from"./index-C9yBzEdM.js";import{t}from"./conformidadeService-DTfsGcFE.js";const n={async listar(){let{data:{user:t}}=await e.auth.getUser();if(!t)throw Error(`N√£o autenticado`);let{data:n}=await e.from(`perfis`).select(`empresa_id, role`).eq(`id`,t.id).single(),r=e.from(`ordens_servico`).select(`
        *,
        cliente:clientes(id, nome, telefone, email)
      `);if(n?.role!==`super_admin`){if(!n?.empresa_id)return[];r=r.eq(`empresa_id`,n.empresa_id)}let{data:i,error:a}=await r.order(`created_at`,{ascending:!1});if(a)throw a;return i||[]},async buscarPorId(t){let{data:n,error:r}=await e.from(`ordens_servico`).select(`
        *,
        cliente:clientes(*)
      `).eq(`id`,t).single();if(r)throw r;return n},async buscarPorPublicId(t){let{data:n,error:r}=await e.from(`ordens_servico`).select(`
                *,
                cliente:clientes(id, nome, endereco, cidade, estado),
                tecnico:perfis!tecnico_id(id, nome)
            `).eq(`public_id`,t).single();return r?(console.error(`Erro ao buscar ordem p√∫blica:`,r),null):n},async criar(t){let{data:{user:n}}=await e.auth.getUser();if(!n)throw Error(`Usu√°rio n√£o autenticado`);let{data:r}=await e.from(`perfis`).select(`empresa_id, role`).eq(`id`,n.id).single();if(!r?.empresa_id)throw Error(`Empresa n√£o encontrada para o usu√°rio`);if(r.role!==`admin`&&r.role!==`super_admin`)throw Error(`Apenas administradores podem criar ordens de servi√ßo`);let{data:i,error:a}=await e.from(`ordens_servico`).insert([{...t,empresa_id:r.empresa_id,tecnico_id:t.tecnico_id||null}]).select().single();if(a)throw a;return i},async atualizar(n,r){if(r.tecnico_id){let e=await this.buscarPorId(n),i=r.tipo_risco_id||e?.tipo_risco_id;if(i){let{valido:e,pendencias:n}=await t.validarTecnicoParaRisco(r.tecnico_id,i);if(!e)throw Error(`T√©cnico n√£o possui as certifica√ß√µes necess√°rias: ${n.join(`, `)}`)}}let{data:i,error:a}=await e.from(`ordens_servico`).update(r).eq(`id`,n).select().single();if(a)throw a;return i},async excluir(t){let{error:n}=await e.from(`ordens_servico`).delete().eq(`id`,t);if(n)throw n},async listarPorStatus(t){let{data:{user:n}}=await e.auth.getUser();if(!n)throw Error(`N√£o autenticado`);let{data:r}=await e.from(`perfis`).select(`empresa_id, role`).eq(`id`,n.id).single(),i=e.from(`ordens_servico`).select(`
        *,
        cliente:clientes(id, nome, telefone)
      `).eq(`status`,t);if(r?.role!==`super_admin`){if(!r?.empresa_id)return[];i=i.eq(`empresa_id`,r.empresa_id)}let{data:a,error:o}=await i.order(`created_at`,{ascending:!1});if(o)throw o;return a||[]},async listarRecentes(t=5){let{data:{user:n}}=await e.auth.getUser();if(!n)throw Error(`N√£o autenticado`);let{data:r}=await e.from(`perfis`).select(`empresa_id, role`).eq(`id`,n.id).single(),i=e.from(`ordens_servico`).select(`
                *,
                cliente:clientes(id, nome, endereco, cidade)
            `);if(r?.role!==`super_admin`){if(!r?.empresa_id)return[];i=i.eq(`empresa_id`,r.empresa_id)}let{data:a,error:o}=await i.order(`created_at`,{ascending:!1}).limit(t);if(o)throw o;return a||[]},async estatisticas(){let{data:{user:t}}=await e.auth.getUser();if(!t)throw Error(`N√£o autenticado`);let{data:n}=await e.from(`perfis`).select(`empresa_id, role`).eq(`id`,t.id).single(),r=new Date().toISOString().split(`T`)[0],i=(t,i)=>{let a=e.from(`ordens_servico`).select(`*`,{count:`exact`,head:!0});if(n?.role!==`super_admin`){if(!n?.empresa_id)return{count:0};a=a.eq(`empresa_id`,n.empresa_id)}return t&&(a=a.eq(`status`,t)),i&&(a=a.gte(`data_agendamento`,r).lt(`data_agendamento`,r+`T23:59:59`)),a};if(n?.role!==`super_admin`&&!n?.empresa_id)return{abertas:0,emAndamento:0,hoje:0,concluidas:0,canceladas:0};let[a,o,s,c,l]=await Promise.all([i(`aberta`),i(`em_andamento`),i(void 0,!0),i(`concluida`),i(`cancelada`)]);return{abertas:a.count||0,emAndamento:o.count||0,hoje:s.count||0,concluidas:c.count||0,canceladas:l.count||0}},async contar(){let{data:{user:t}}=await e.auth.getUser();if(!t)throw Error(`N√£o autenticado`);let{data:n}=await e.from(`perfis`).select(`empresa_id, role`).eq(`id`,t.id).single(),r=e.from(`ordens_servico`).select(`*`,{count:`exact`,head:!0});if(n?.role!==`super_admin`){if(!n?.empresa_id)return 0;r=r.eq(`empresa_id`,n.empresa_id)}let{count:i,error:a}=await r;if(a)throw a;return i||0},async aceitarOrdem(t,n=`imediato`){let{error:r}=await e.from(`ordens_servico`).update({status:`em_andamento`,rastreamento_ativo:n===`imediato`}).eq(`id`,t);if(r)throw r;console.log(`NOTIFICA√á√ÉO CLIENTE: T√©cnico aceitou o servi√ßo (${n}).`)},getWhatsAppTechLink(e,t,n){let r=`${window.location.origin}/ordens/${e.id}`,i=`Ol√°! Voc√™ recebeu uma nova Ordem de Servi√ßo da empresa ${n}.

üìå Equipamento: ${e.equipamento||`N/A`}
üõ† Servi√ßo: ${e.tipo.charAt(0).toUpperCase()+e.tipo.slice(1)}
üìù Descri√ß√£o: ${e.descricao||`N/A`}

üîó Acesse aqui:
${r}`;return`https://wa.me/${t.replace(/\D/g,``)}?text=${encodeURIComponent(i)}`},getWhatsAppClientLink(e,t,n){let r=`${window.location.origin}/track/${e.public_id}`,i=``;return i=n===`caminho`?`Ol√°! Seu t√©cnico aceitou o chamado e j√° est√° a caminho. Acompanhe em tempo real: ${r}`:`Ol√°! Seu chamado foi agendado para o dia ${e.data_agendamento?new Date(e.data_agendamento).toLocaleDateString(`pt-BR`):`em breve`}. Voc√™ receber√° um link de rastreio quando o t√©cnico iniciar o deslocamento.`,`https://wa.me/${t.replace(/\D/g,``)}?text=${encodeURIComponent(i)}`}};export{n as t};